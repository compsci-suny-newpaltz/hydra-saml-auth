<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="https://hydra.newpaltz.edu/SUNYCAT.png" />
  <title>Hydra Dashboard - SUNY New Paltz</title>
  <style>
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Dark Mode Styles */
    .dark body,
    body.dark {
      background-color: #111827 !important;
      color: #f3f4f6 !important;
    }
    .dark .bg-gray-50 { background-color: #111827 !important; }
    .dark .bg-white { background-color: #1f2937 !important; }
    .dark .bg-gray-100 { background-color: #374151 !important; }
    .dark .text-gray-900 { color: #f3f4f6 !important; }
    .dark .text-gray-800 { color: #e5e7eb !important; }
    .dark .text-gray-700 { color: #d1d5db !important; }
    .dark .text-gray-600 { color: #9ca3af !important; }
    .dark .text-gray-500 { color: #9ca3af !important; }
    .dark .text-\[\#052049\] { color: #60a5fa !important; }
    .dark .border-\[\#052049\] { border-color: #60a5fa !important; }
    .dark .border { border-color: #374151 !important; }
    .dark .border-b { border-color: #374151 !important; }
    .dark .border-gray-200 { border-color: #374151 !important; }
    .dark .border-gray-300 { border-color: #4b5563 !important; }
    .dark .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2) !important; }
    .dark .rounded { border-color: #374151; }
    .dark input, .dark select, .dark textarea {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }
    .dark input::placeholder { color: #9ca3af !important; }
    .dark .bg-yellow-50 { background-color: #422006 !important; }
    .dark .bg-yellow-100 { background-color: #451a03 !important; }
    .dark .border-yellow-200 { border-color: #854d0e !important; }
    .dark .text-yellow-800 { color: #fef08a !important; }
    .dark .text-yellow-700 { color: #fde047 !important; }
    .dark .text-yellow-600 { color: #facc15 !important; }
    .dark .bg-blue-50 { background-color: #1e3a5f !important; }
    .dark .border-blue-200 { border-color: #1d4ed8 !important; }
    .dark .text-blue-800 { color: #93c5fd !important; }
    .dark .text-blue-700 { color: #60a5fa !important; }
    .dark .bg-purple-50 { background-color: #2e1065 !important; }
    .dark .border-purple-200 { border-color: #7c3aed !important; }
    .dark .text-purple-800 { color: #c4b5fd !important; }
    .dark .text-purple-600 { color: #a78bfa !important; }
    .dark .bg-green-50 { background-color: #14532d !important; }
    .dark .text-green-600 { color: #4ade80 !important; }
    .dark .bg-red-100 { background-color: #450a0a !important; }
    .dark .text-red-700 { color: #fca5a5 !important; }
    .dark .hover\:text-gray-900:hover { color: #f3f4f6 !important; }

    /* Dark mode for modals */
    .dark #resource-modal > div,
    .dark #wipe-modal > div {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }

    /* Dark mode header */
    .dark header {
      background-color: #0f172a !important;
    }

    /* Dark mode admin panel */
    .dark #admin-dropdown {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }
    .dark #admin-dropdown .bg-gray-50 {
      background-color: #111827 !important;
    }

    /* Dark mode toast container */
    .dark #toast-container div {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    /* Smooth transition for dark mode */
    body, header, main, .bg-white, .bg-gray-50, input, select, textarea {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Dark mode for tutorial */
    .dark .tutorial-tooltip,
    .dark .tutorial-welcome {
      background: #1f2937 !important;
      color: #f3f4f6 !important;
    }
    .dark .tutorial-tooltip::before,
    .dark .tutorial-welcome::before {
      background: #1f2937 !important;
    }
    .dark .tutorial-tooltip h3,
    .dark .tutorial-welcome h2 {
      color: #f3f4f6 !important;
    }
    .dark .tutorial-feature-list li {
      color: #d1d5db !important;
    }
    .dark .tutorial-feature-list li i {
      background: #374151 !important;
      color: #a78bfa !important;
    }
    .dark .tutorial-btn-secondary {
      background: #374151 !important;
      color: #e5e7eb !important;
    }
    .dark .tutorial-btn-secondary:hover {
      background: #4b5563 !important;
    }

    /* Dark mode for FAQ section */
    .dark .divide-y > details summary {
      color: #f3f4f6 !important;
      background-color: #1f2937 !important;
    }
    .dark .divide-y > details summary:hover {
      background-color: #374151 !important;
    }
    .dark .divide-y > details > div {
      color: #d1d5db !important;
      background-color: #1f2937 !important;
    }
    .dark .divide-y > details a.text-blue-600,
    .dark .divide-y > details a {
      color: #60a5fa !important;
    }
    .dark .border.rounded-lg > h4.bg-gray-50,
    .dark .mt-6.border.rounded-lg > h4 {
      background-color: #374151 !important;
      color: #f3f4f6 !important;
    }
    .dark .mt-6.border.rounded-lg {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }
    .dark .mt-6.border.rounded-lg .text-blue-600 {
      color: #60a5fa !important;
    }
    /* Dark mode for FAQ expanded content - explicit targeting */
    .dark details.group > div.px-4 {
      background-color: #1f2937 !important;
    }
    .dark details.group .text-gray-600 {
      color: #9ca3af !important;
    }
    .dark details.group summary.hover\:bg-gray-50:hover {
      background-color: #374151 !important;
    }

    /* Dark mode for Server Status section */
    .dark #server-status-section {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }
    .dark #server-status-section summary {
      color: #f3f4f6 !important;
    }
    .dark #server-status-section summary:hover {
      background-color: #374151 !important;
    }
    .dark #server-status-section .bg-gray-50 {
      background-color: #111827 !important;
    }
    .dark #server-status-section .text-gray-600,
    .dark #server-status-section .text-gray-500 {
      color: #9ca3af !important;
    }
    .dark #server-status-section .font-semibold {
      color: #f3f4f6 !important;
    }

    /* Dark mode for whitelist modal */
    .dark #whitelist-modal > div > div {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }
    .dark #whitelist-modal .bg-gray-50 {
      background-color: #111827 !important;
    }
    .dark #whitelist-modal .bg-gray-100 {
      background-color: #1f2937 !important;
    }
    .dark #whitelist-modal input,
    .dark #whitelist-modal select {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }
    .dark #whitelist-modal th,
    .dark #whitelist-modal td {
      color: #e5e7eb !important;
    }
    .dark #whitelist-modal .hover\:bg-gray-50:hover {
      background-color: #374151 !important;
    }

    /* Mobile-first responsive fixes */
    @media (max-width: 640px) {
      #admin-panel {
        right: 0.5rem;
        bottom: 0.75rem;
      }
      main {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      h2.text-2xl {
        font-size: 1.25rem;
      }
      .tutorial-tooltip {
        max-width: calc(100vw - 2rem) !important;
        left: 1rem !important;
        right: 1rem !important;
      }
    }

    /* Tutorial Overlay Styles */
    .tutorial-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .tutorial-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .tutorial-spotlight {
      position: absolute;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
      border-radius: 8px;
      transition: all 0.4s ease;
      z-index: 9999;
      pointer-events: none;
    }
    .tutorial-spotlight::after {
      content: '';
      position: absolute;
      inset: -4px;
      border: 2px solid #8b5cf6;
      border-radius: 12px;
      animation: spotlight-pulse 2s infinite;
    }
    @keyframes spotlight-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.02); }
    }

    .tutorial-tooltip {
      position: absolute;
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      z-index: 10000;
      transform: translateY(10px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .tutorial-tooltip.visible {
      transform: translateY(0);
      opacity: 1;
    }
    .tutorial-tooltip::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      transform: rotate(45deg);
    }
    .tutorial-tooltip.arrow-top::before { top: -8px; left: 32px; }
    .tutorial-tooltip.arrow-bottom::before { bottom: -8px; left: 32px; }
    .tutorial-tooltip.arrow-left::before { left: -8px; top: 32px; }
    .tutorial-tooltip.arrow-right::before { right: -8px; top: 32px; }

    .tutorial-progress {
      display: flex;
      gap: 6px;
      margin-top: 16px;
    }
    .tutorial-progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e5e7eb;
      transition: all 0.3s ease;
    }
    .tutorial-progress-dot.active {
      background: #8b5cf6;
      transform: scale(1.2);
    }
    .tutorial-progress-dot.completed {
      background: #22c55e;
    }

    .tutorial-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .tutorial-btn-primary {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
    }
    .tutorial-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .tutorial-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .tutorial-btn-secondary:hover {
      background: #e5e7eb;
    }
    .tutorial-btn-skip {
      background: transparent;
      color: #9ca3af;
      padding: 10px 12px;
    }
    .tutorial-btn-skip:hover {
      color: #6b7280;
    }

    .tutorial-welcome {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      text-align: center;
      z-index: 10000;
      opacity: 0;
      transition: all 0.4s ease;
    }
    .tutorial-welcome.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .tutorial-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }

    .tutorial-route-box {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      color: #4ade80;
      text-align: left;
    }
    .tutorial-route-box .route-method {
      color: #60a5fa;
      font-weight: bold;
    }
    .tutorial-route-box .route-path {
      color: #fbbf24;
    }

    .tutorial-feature-list {
      text-align: left;
      margin: 16px 0;
    }
    .tutorial-feature-list li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #4b5563;
    }
    .tutorial-feature-list li i {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      border-radius: 6px;
      color: #8b5cf6;
      font-size: 12px;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 transition-colors duration-300">
  <!-- Dark Mode Initialization (prevents flash) -->
  <script>
    (function() {
      const darkMode = localStorage.getItem('hydra_dark_mode');
      // Default to light mode, only enable dark if explicitly set to 'true'
      if (darkMode === 'true') {
        document.body.classList.add('dark');
      }
    })();
  </script>
  <header class="bg-[#052049] text-white transition-colors duration-300">
    <div class="max-w-5xl mx-auto px-4 py-4 relative flex items-center gap-3">
      <img id="hydra-cat" src="https://hydra.newpaltz.edu/SUNYCAT.png" alt="Hydra" class="h-8 w-8 rounded cursor-pointer select-none" />
      <h1 class="text-xl font-semibold">SUNY New Paltz - Hydra</h1>
      <div class="absolute top-4 right-4 flex items-center gap-2">
        <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
        <!-- Whitelist Management Button (Admin Only) -->
        <button id="whitelist-btn" onclick="openWhitelistModal()"
          class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-sm font-medium"
          title="Manage admin whitelist">
          <i class="fas fa-user-shield"></i>
          <span class="hidden sm:inline">Whitelist</span>
        </button>
        <% } %>
        <!-- Demo/Tutorial Button -->
        <button id="demo-btn" onclick="window.hydra_tutorial && window.hydra_tutorial.reset()"
          class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-sm font-medium"
          title="Start interactive tour">
          <i class="fas fa-graduation-cap"></i>
          <span class="hidden sm:inline">Demo</span>
        </button>
        <!-- Dark Mode Toggle -->
        <button id="dark-mode-toggle"
          class="flex items-center justify-center w-9 h-9 rounded-lg bg-white/10 hover:bg-white/20 transition-colors"
          title="Toggle dark mode">
          <i id="dark-mode-icon" class="fas fa-moon"></i>
        </button>
        <!-- GitHub Link -->
        <a href="https://github.com/lettucegoblin/hydra-saml-auth" target="_blank"
          class="flex items-center justify-center w-9 h-9 rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
          <i class="fab fa-github text-lg"></i>
        </a>
      </div>
    </div>
  </header>

  <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
  <!-- Admin Approval Panel -->
  <div id="admin-panel" class="fixed bottom-4 right-4 z-50">
    <!-- Dropdown Panel (opens upward) -->
    <div id="admin-dropdown" class="hidden absolute right-0 bottom-14 w-[calc(100vw-2rem)] sm:w-96 max-w-[384px] bg-white rounded-lg shadow-xl border border-gray-200">
      <div class="p-4 border-b bg-gray-50 rounded-t-lg">
        <h3 class="font-bold text-gray-800"><i class="fas fa-clipboard-check mr-2"></i>Pending Approvals</h3>
      </div>
      <div id="admin-requests-list" class="max-h-96 overflow-y-auto">
        <p class="p-4 text-gray-500 text-center">Loading...</p>
      </div>
      <div class="p-3 border-t bg-gray-50 rounded-b-lg flex gap-2">
        <button id="approve-all-btn" class="flex-1 bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 transition-colors text-sm font-medium">
          <i class="fas fa-check-double mr-1"></i> Approve All
        </button>
        <button id="refresh-requests-btn" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 transition-colors" title="Refresh">
          <i class="fas fa-sync"></i>
        </button>
      </div>
    </div>

    <!-- Notification Bell -->
    <button id="admin-toggle" class="relative bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors">
      <i class="fas fa-bell text-lg"></i>
      <span id="admin-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </button>
  </div>
  <% } %>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <div class="bg-white rounded shadow p-6">
      <div class="border-b pb-4 mb-4 flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold text-[#052049]">Welcome, <%= user.firstName %>
              <%= user.lastName %>
          </h2>
          <p class="mt-1"><span class="font-semibold">Email:</span>
            <%= user.email %>
          </p>
          <p><span class="font-semibold">Username:</span>
            <%= user.displayName %>
          </p>
        </div>
        <div class="shrink-0">
          <a href="/logout?returnTo=https://hydra.newpaltz.edu/dashboard"
            class="inline-flex items-center px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Logout</a>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold">Authentication Status</h3>
        <p><span class="font-semibold">Status:</span> <span class="text-green-600 font-bold">Logged In</span></p>
      </div>


      <!-- Tabs -->
      <div>
        <div class="flex border-b mb-4" role="tablist">
          <button id="tab-containers" class="px-4 py-2 -mb-px border-b-2 border-[#052049] text-[#052049] font-medium"
            data-target="#panel-containers">Containers</button>
          <button id="tab-openwebui" class="px-4 py-2 text-gray-600 hover:text-gray-900"
            data-target="#panel-openwebui">OpenWebUI</button>
          <button id="tab-n8n" class="px-4 py-2 text-gray-600 hover:text-gray-900" data-target="#panel-n8n">n8n</button>
          <button id="tab-minecraft" class="px-4 py-2 text-gray-600 hover:text-gray-900 hidden"
            data-target="#panel-minecraft">Minecraft</button>
          <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
          <button id="tab-infra" class="px-4 py-2 text-gray-600 hover:text-gray-900"
            data-target="#panel-infra"><i class="fas fa-server"></i> Infra Services</button>
          <% } %>
        </div>

        <section id="panel-minecraft" class="hidden">
          <h3 class="text-xl font-semibold mb-2">Minecraft Server</h3>
          <form id="minecraft-form" class="space-y-3 max-w-md">
            <div>
              <label for="minecraft-username" class="block text-sm font-medium">Minecraft Username</label>
              <input type="text" id="minecraft-username" name="minecraft-username"
                class="mt-1 block w-full rounded border border-gray-300 px-3 py-2" placeholder="e.g. Notch" />
              <p id="minecraft-help" class="text-xs text-gray-500 mt-2 hidden">Enter your Minecraft username (e.g. <span
                  class="font-mono">Notch</span>). This is <span class="font-bold">required</span> to join the server.
              </p>
            </div>
            <button type="submit"
              class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Save
              Username</button>
            <div id="minecraft-message" class="mt-3"></div>
          </form>
          <div class="mb-3">
            <label for="minecraft-server-url" class="block text-sm font-medium">Server Address (Copy to
              Minecraft)</label>
            <div class="flex items-center gap-2 mt-1">
              <input type="text" id="minecraft-server-url"
                class="block w-full rounded border border-gray-300 px-3 py-2 font-mono bg-gray-100"
                value="hydra.newpaltz.edu" readonly />
              <button type="button" id="copy-server-url"
                class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" title="Copy">Copy</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Paste this address into Minecraft to join the server.</p>
          </div>
          <p class="text-gray-700 mb-2">More Minecraft configuration at the <a
              href="https://hydra.newpaltz.edu/minecraftdashboard/" target="_blank"
              class="text-blue-600 underline">configuration panel</a>.</p>

        </section>

        <section id="panel-openwebui" class="hidden">
          <h3 class="text-xl font-semibold mb-2">OpenWebUI Account Management</h3>
          <p class="text-gray-700 mb-2">Welcome to the OpenWebUI account management portal. OpenWebUI provides a
            comprehensive interface for accessing AI models and managing your preferences in a secure environment.</p>
          <p class="text-gray-700 mb-4">Our institution hosts an OpenWebUI instance at <a
              href="https://gpt.hydra.newpaltz.edu" target="_blank"
              class="text-blue-600 underline">https://gpt.hydra.newpaltz.edu</a>. To utilize these services, you'll need
            to establish credentials through this portal.</p>

          <div id="webui-status-loading" class="text-gray-600">Checking your OpenWebUI account status...</div>

          <div id="webui-create-account" class="hidden">
            <p class="mb-2">You don't have an OpenWebUI account yet.</p>
            <form id="create-account-form" class="space-y-3">
              <div>
                <label for="new-password" class="block text-sm font-medium">Set Password</label>
                <input type="password" id="new-password" name="password" required
                  class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
              </div>
              <div>
                <label for="confirm-password" class="block text-sm font-medium">Confirm Password</label>
                <input type="password" id="confirm-password" name="confirm-password" required
                  class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
              </div>
              <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Create
                OpenWebUI Account</button>
            </form>
            <div id="create-account-message" class="mt-3"></div>
          </div>

          <div id="webui-account-exists" class="hidden">
            <p class="mb-2">You have an existing OpenWebUI account.</p>
            <p><span class="font-semibold">Username:</span> <span id="webui-username"></span></p>
            <p><span class="font-semibold">Role:</span> <span id="webui-role"></span></p>

            <div id="change-password-section" class="mt-4">
              <h4 class="font-semibold mb-2">Change Password</h4>
              <form id="change-password-form" class="space-y-3">
                <div>
                  <label for="new-password-change" class="block text-sm font-medium">New Password</label>
                  <input type="password" id="new-password-change" name="new-password" required
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <div>
                  <label for="confirm-password-change" class="block text-sm font-medium">Confirm New Password</label>
                  <input type="password" id="confirm-password-change" name="confirm-password" required
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <button type="submit"
                  class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Update
                  Password</button>
              </form>
              <div id="change-password-message" class="mt-3"></div>
            </div>
          </div>
        </section>

        <section id="panel-n8n" class="hidden">
          <h3 class="text-xl font-semibold mb-2">n8n Account Management</h3>
          <p class="text-gray-700 mb-4">Manage your n8n automation account.</p>

          <div id="n8n-status-loading" class="text-gray-600">Checking your n8n account status...</div>
          <div id="n8n-account-exists" class="hidden">
            <p><span class="font-semibold">Status:</span> Found</p>
            <p><span class="font-semibold">Role:</span> <span id="n8n-role"></span></p>
            <p class="mt-2">You can log in to n8n at <a href="https://n8n.hydra.newpaltz.edu" target="_blank"
                class="text-blue-600 underline">https://n8n.hydra.newpaltz.edu</a></p>

            <div class="mt-4 border-t pt-4">
              <h4 class="font-semibold mb-2">Change n8n Password</h4>
              <form id="n8n-change-password-form" class="space-y-3">
                <div>
                  <label for="n8n-new-password" class="block text-sm font-medium">New Password</label>
                  <input type="password" id="n8n-new-password" name="new-password" required minlength="8"
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                  <p class="text-sm text-gray-500 mt-1">Must be at least 8 characters</p>
                </div>
                <div>
                  <label for="n8n-confirm-password" class="block text-sm font-medium">Confirm New Password</label>
                  <input type="password" id="n8n-confirm-password" name="confirm-password" required minlength="8"
                    class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                </div>
                <button type="submit"
                  class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Update
                  n8n Password</button>
              </form>
              <div id="n8n-change-password-message" class="mt-3"></div>
            </div>
          </div>
          <div id="n8n-create-account" class="hidden">
            <p>No n8n account found. You can request an invite:</p>
            <form id="n8n-create-form" class="mt-3">
              <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Request
                n8n Invite</button>
            </form>
            <div id="n8n-create-message" class="mt-3"></div>
          </div>
          <div id="n8n-invite" class="hidden mt-3">
            <p>Invite created. Use this link to complete setup:</p>
            <p><a id="n8n-invite-link" href="#" class="text-blue-600 underline" target="_blank"></a></p>
          </div>
        </section>
      </div>

      <section id="panel-containers">
        <h3 class="text-xl font-semibold mb-4">Student Container</h3>
        <p class="text-gray-700 mb-4">Manage your personal development container with VS Code, Jupyter, and custom port routing.</p>

        <!-- Container Status Section -->
        <div id="container-status-section" class="mb-6 border rounded p-4 bg-gray-50">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-lg font-semibold"><i class="fas fa-server"></i> Container Status</h4>
            <span id="container-state-badge" class="px-3 py-1 rounded text-sm font-medium"></span>
          </div>
          <!-- Resource Info Display -->
          <div id="container-resources" class="hidden mb-4 p-3 bg-white rounded border">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 sm:gap-3 text-xs sm:text-sm">
              <div class="flex items-center gap-2">
                <i class="fas fa-microchip text-blue-500"></i>
                <span><strong id="res-cpu">-</strong> CPU</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-memory text-green-500"></i>
                <span><strong id="res-ram">-</strong> RAM</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-hdd text-purple-500"></i>
                <span><strong id="res-storage">-</strong> Storage</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-bolt text-yellow-500"></i>
                <span><strong id="res-gpu">-</strong> GPU</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-server text-gray-500"></i>
                <span>Node: <strong id="res-node">-</strong></span>
              </div>
            </div>
            <!-- Migration Banner -->
            <div id="migration-banner" class="hidden mt-3 p-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded border border-purple-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-medium text-purple-800"><i class="fas fa-rocket mr-2"></i>GPU Resources Approved!</p>
                  <p class="text-sm text-purple-600">Ready to migrate to <strong id="migrate-target-node">Cerberus</strong> with <strong id="migrate-gpu-count">2</strong> GPU(s)</p>
                </div>
                <button onclick="migrateContainer()" id="migrate-btn"
                  class="px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 font-medium">
                  <i class="fas fa-exchange-alt mr-1"></i> Migrate Now
                </button>
              </div>
            </div>
          </div>
          <div id="container-not-created" class="hidden">
            <p class="text-gray-600 text-sm mb-3">Your student container has not been created yet.</p>
            <button onclick="initContainer()" id="init-btn"
              class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
              <i class="fas fa-plus-circle"></i> Initialize Container
            </button>
          </div>
          <div id="container-controls" class="hidden">
            <div class="flex flex-wrap gap-2">
              <button onclick="startContainer()" id="start-btn"
                class="px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-sm">
                <i class="fas fa-play"></i> Start
              </button>
              <button onclick="stopContainer()" id="stop-btn"
                class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700 text-sm">
                <i class="fas fa-stop"></i> Stop
              </button>
              <button onclick="restartContainer()" id="restart-btn"
                class="px-3 py-2 rounded bg-orange-500 text-white hover:bg-orange-600 text-sm">
                <i class="fas fa-sync-alt"></i> Restart
              </button>
              <button onclick="openLogs()" id="logs-btn"
                class="px-3 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 text-sm">
                <i class="fas fa-file-alt"></i> Logs
              </button>
              <button onclick="openTerminal()" id="terminal-btn"
                class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm">
                <i class="fas fa-terminal"></i> Terminal
              </button>
              <button onclick="showWipeModal()" id="wipe-btn" title="Wipe Volume"
                class="px-3 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600 text-sm">
                <i class="fas fa-exclamation-triangle"></i> Wipe
              </button>
              <button onclick="showResourceModal()" id="resource-config-btn" title="Configure Resources"
                class="px-3 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 text-sm">
                <i class="fas fa-cog"></i> Configure
              </button>
            </div>
          </div>
          <div id="container-message" class="mt-3"></div>
        </div>

        <!-- Pending Resource Request Status -->
        <div id="pending-request-section" class="mb-6 border rounded p-4 bg-yellow-50 border-yellow-200 hidden">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="text-lg font-semibold text-yellow-800"><i class="fas fa-clock"></i> Pending Resource Request</h4>
              <p class="text-sm text-yellow-700 mt-1">
                <span class="font-medium">Target:</span> <span id="pending-target-node">-</span> |
                <span class="font-medium">Resources:</span> <span id="pending-resources">-</span> |
                <span class="font-medium">Duration:</span> <span id="pending-duration">-</span>
              </p>
              <p class="text-xs text-yellow-600 mt-1">Submitted: <span id="pending-submitted">-</span></p>
            </div>
            <button onclick="cancelPendingRequest()" class="px-3 py-2 rounded bg-yellow-600 text-white hover:bg-yellow-700 text-sm">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>

        <!-- Wipe Confirmation Modal -->
        <div id="wipe-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
              </div>
              <h3 class="text-lg leading-6 font-medium text-gray-900">Wipe Container Volume?</h3>
              <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                  This will permanently delete all data in your container's volume, including all files and settings. This cannot be undone.
                  Your container will be recreated fresh.
                </p>
              </div>
              <div class="items-center px-4 py-3">
                <button id="cancel-wipe-btn"
                  class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">
                  Cancel
                </button>
                <button id="confirm-wipe-btn"
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                  Yes, Wipe It
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Whitelist Management Modal -->
        <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
        <div id="whitelist-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-4 sm:top-10 mx-auto p-3 sm:p-5 border w-[95%] sm:w-11/12 max-w-lg sm:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-user-shield text-blue-600"></i> Admin Whitelist</h3>
              <button onclick="closeWhitelistModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>

            <!-- Quick Select Existing Users -->
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium text-sm"><i class="fas fa-users text-blue-600"></i> Existing Users</h4>
                <div class="flex gap-2">
                  <button onclick="selectAllWhitelistUsers('all')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                    <i class="fas fa-check-double mr-1"></i>Select All
                  </button>
                  <button onclick="selectAllWhitelistUsers('online')" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                    <i class="fas fa-circle mr-1"></i>Online Only
                  </button>
                  <button onclick="addSelectedToWhitelist()" id="whitelist-add-selected-btn" class="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 hidden">
                    <i class="fas fa-plus mr-1"></i>Add Selected (<span id="whitelist-selected-count">0</span>)
                  </button>
                </div>
              </div>
              <div id="whitelist-user-chips" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                <span class="text-xs text-gray-400">Loading users...</span>
              </div>
            </div>

            <!-- Add New User Form -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
              <h4 class="font-medium mb-3"><i class="fas fa-plus-circle text-green-600"></i> Add User Manually</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="relative">
                  <label class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                  <input type="email" id="whitelist-email" placeholder="user@newpaltz.edu"
                    class="w-full px-3 py-2 border rounded text-sm" list="whitelist-suggestions">
                  <datalist id="whitelist-suggestions"></datalist>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Role</label>
                  <select id="whitelist-role" class="w-full px-3 py-2 border rounded text-sm">
                    <option value="admin">Admin</option>
                    <option value="faculty">Faculty</option>
                    <option value="ta">TA</option>
                  </select>
                </div>
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">Reason (optional)</label>
                <input type="text" id="whitelist-reason" placeholder="e.g., Course instructor for CPS 101"
                  class="w-full px-3 py-2 border rounded text-sm">
              </div>
              <div class="mt-3">
                <button onclick="addToWhitelist()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                  <i class="fas fa-plus mr-1"></i> Add to Whitelist
                </button>
              </div>
              <div id="whitelist-add-message" class="mt-2"></div>
            </div>

            <!-- Current Whitelist -->
            <div>
              <h4 class="font-medium mb-3"><i class="fas fa-list text-blue-600"></i> Current Whitelist</h4>
              <div id="whitelist-table" class="max-h-64 overflow-y-auto border rounded">
                <table class="w-full text-sm">
                  <thead class="bg-gray-100 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left">Email</th>
                      <th class="px-3 py-2 text-left">Role</th>
                      <th class="px-3 py-2 text-left">Source</th>
                      <th class="px-3 py-2 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="whitelist-body">
                    <tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Resource Configuration Modal -->
        <div id="resource-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-4 sm:top-10 mx-auto p-3 sm:p-5 border w-[95%] sm:w-11/12 max-w-lg sm:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-cog text-purple-600"></i> Configure Resources</h3>
              <button onclick="hideResourceModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>

            <!-- Current Configuration -->
            <div class="bg-gray-50 rounded p-3 mb-4">
              <p class="text-sm font-medium text-gray-700 mb-2">Current Configuration</p>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-gray-500">Node:</span> <span id="current-node" class="font-medium">-</span></div>
                <div><span class="text-gray-500">Memory:</span> <span id="current-memory" class="font-medium">-</span></div>
                <div><span class="text-gray-500">CPUs:</span> <span id="current-cpus" class="font-medium">-</span></div>
                <div><span class="text-gray-500">Storage:</span> <span id="current-storage" class="font-medium">-</span></div>
              </div>
            </div>

            <!-- Auto-Recommendation Banner -->
            <div id="recommendation-banner" class="bg-blue-50 border border-blue-200 rounded p-3 mb-4 hidden">
              <div class="flex items-start gap-2">
                <i class="fas fa-lightbulb text-blue-600 mt-0.5"></i>
                <div class="flex-1">
                  <p class="text-sm font-medium text-blue-800">Recommended: <span id="rec-node-name">Hydra</span></p>
                  <p class="text-xs text-blue-700" id="rec-reason">Best node for your workload</p>
                  <button type="button" onclick="applyRecommendation()" class="mt-1 text-xs text-blue-700 underline hover:text-blue-900">
                    Apply recommendation
                  </button>
                </div>
              </div>
            </div>

            <!-- Node Status Cards -->
            <div class="grid grid-cols-3 gap-2 mb-4">
              <!-- Hydra -->
              <div id="node-card-hydra" class="border rounded p-2 cursor-pointer hover:border-purple-400 transition-colors" onclick="selectNode('hydra')">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs font-semibold">Hydra</span>
                  <span id="hydra-status-dot" class="w-2 h-2 rounded-full bg-green-500"></span>
                </div>
                <p class="text-xs text-gray-500 mb-1">Control Plane</p>
                <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
                  <div id="hydra-capacity-bar" class="h-full bg-green-500 transition-all" style="width: 30%"></div>
                </div>
                <p class="text-xs text-gray-600"><span id="hydra-slots">70</span> slots free</p>
              </div>
              <!-- Chimera -->
              <div id="node-card-chimera" class="border rounded p-2 cursor-pointer hover:border-purple-400 transition-colors" onclick="selectNode('chimera')">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs font-semibold">Chimera</span>
                  <span id="chimera-status-dot" class="w-2 h-2 rounded-full bg-green-500"></span>
                </div>
                <p class="text-xs text-gray-500 mb-1">3× RTX 3090</p>
                <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
                  <div id="chimera-capacity-bar" class="h-full bg-yellow-500 transition-all" style="width: 60%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span><span id="chimera-slots">8</span> slots</span>
                  <span><span id="chimera-gpu-util">45</span>% GPU</span>
                </div>
              </div>
              <!-- Cerberus -->
              <div id="node-card-cerberus" class="border rounded p-2 cursor-pointer hover:border-purple-400 transition-colors" onclick="selectNode('cerberus')">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs font-semibold">Cerberus</span>
                  <span id="cerberus-status-dot" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                </div>
                <p class="text-xs text-gray-500 mb-1">2× RTX 5090</p>
                <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
                  <div id="cerberus-capacity-bar" class="h-full bg-red-500 transition-all" style="width: 80%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span><span id="cerberus-slots">2</span> slots</span>
                  <span><span id="cerberus-gpu-util">92</span>% GPU</span>
                </div>
              </div>
            </div>

            <form id="resource-config-form" class="space-y-4">
              <!-- Target Node (hidden, controlled by cards) -->
              <input type="hidden" id="target-node" value="hydra">

              <!-- Selected Node Display -->
              <div class="bg-purple-50 border border-purple-200 rounded p-3">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-purple-800">Selected: <span id="selected-node-label">Hydra (Control Plane)</span></p>
                    <p id="node-status" class="text-xs text-purple-600 mt-1"></p>
                  </div>
                  <div id="selected-node-gpu-info" class="text-right hidden">
                    <p class="text-xs text-purple-700"><span id="selected-gpu-avail">3</span> GPUs available</p>
                    <p class="text-xs text-purple-600"><span id="selected-gpu-model">RTX 3090</span></p>
                  </div>
                </div>
              </div>

              <!-- Resource Preset -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Resource Preset</label>
                <select id="resource-preset" class="w-full rounded border border-gray-300 px-3 py-2">
                  <option value="conservative">Conservative (4GB RAM, 2 CPU) - Auto-approved</option>
                  <option value="standard">Standard (8GB RAM, 4 CPU)</option>
                  <option value="enhanced">Enhanced (16GB RAM, 8 CPU)</option>
                  <option value="gpu_inference">GPU Inference (32GB RAM, 8 CPU, 1 GPU)</option>
                  <option value="gpu_training">GPU Training (48GB RAM, 16 CPU, 2 GPU)</option>
                </select>
                <p id="preset-capacity-warning" class="text-xs text-orange-600 mt-1 hidden">
                  <i class="fas fa-exclamation-triangle"></i> Limited capacity for this preset
                </p>
              </div>

              <!-- Storage Tier -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Storage</label>
                <select id="storage-tier" class="w-full rounded border border-gray-300 px-3 py-2">
                  <option value="10">10 GB</option>
                  <option value="25">25 GB</option>
                  <option value="40" selected>40 GB (Default)</option>
                  <option value="50">50 GB</option>
                  <option value="75">75 GB (Requires approval)</option>
                  <option value="100">100 GB (Requires approval)</option>
                  <option value="200">200 GB - GPU Training (Requires approval)</option>
                </select>
              </div>

              <!-- Duration (Days) -->
              <div id="duration-section">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Duration <span class="text-gray-500">(days until auto-return to Hydra)</span>
                </label>
                <select id="duration-days" class="w-full rounded border border-gray-300 px-3 py-2">
                  <option value="1">1 Day - Quick testing</option>
                  <option value="3">3 Days - Short assignment</option>
                  <option value="7" selected>1 Week - Good for short projects</option>
                  <option value="14">2 Weeks - Standard project length</option>
                  <option value="30">1 Month - Semester project</option>
                  <option value="60">2 Months - Extended project (Requires approval)</option>
                  <option value="90">3 Months - Full semester (Requires approval)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-info-circle"></i> After this time, your container will automatically move back to Hydra. Your files will be preserved.
                </p>
              </div>

              <!-- Reason (for approval requests) -->
              <div id="reason-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Request</label>
                <textarea id="request-reason" rows="2" class="w-full rounded border border-gray-300 px-3 py-2"
                  placeholder="Briefly explain why you need these resources..."></textarea>
              </div>

              <!-- Approval Warning -->
              <div id="approval-warning" class="bg-yellow-50 border border-yellow-200 rounded p-3 hidden">
                <p class="text-sm text-yellow-800">
                  <i class="fas fa-exclamation-circle"></i>
                  <strong>Requires Approval:</strong> This configuration requires admin approval. You will receive an email when reviewed.
                </p>
              </div>

              <!-- Auto-Approve Info -->
              <div id="auto-approve-info" class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-sm text-green-800">
                  <i class="fas fa-check-circle"></i>
                  <strong>Auto-approved:</strong> Applied immediately on next container restart.
                </p>
              </div>

              <!-- Queue/Wait Time Info -->
              <div id="queue-info" class="bg-gray-50 border border-gray-200 rounded p-3 hidden">
                <p class="text-sm text-gray-700">
                  <i class="fas fa-clock"></i>
                  <strong>Estimated Wait:</strong> <span id="estimated-wait">Immediate</span>
                </p>
              </div>

              <div id="resource-modal-message" class="mt-2"></div>

              <div class="flex justify-end gap-2 pt-2">
                <button type="button" onclick="hideResourceModal()"
                  class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                  Cancel
                </button>
                <button type="submit" id="submit-resource-btn"
                  class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                  <i class="fas fa-paper-plane"></i> Submit Request
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Essential Services Section -->
        <div id="services-section" class="mb-6 border rounded p-4 hidden">
          <h4 class="text-lg font-semibold mb-3"><i class="fas fa-cogs"></i> Essential Services</h4>
          <div class="space-y-3">
            <div class="flex items-center justify-between border-b pb-3">
              <div class="flex items-center gap-3">
                <i class="fas fa-code text-indigo-600"></i>
                <div>
                  <div class="font-semibold">VS Code</div>
                  <div id="vscode-service-status" class="text-sm text-gray-600"></div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="startService('code-server')" id="vscode-start-btn"
                  class="px-3 py-1 text-sm rounded bg-green-100 hover:bg-green-200 border border-green-300 text-green-700">
                  Start
                </button>
                <button onclick="stopService('code-server')" id="vscode-stop-btn"
                  class="px-3 py-1 text-sm rounded bg-red-100 hover:bg-red-200 border border-red-300 text-red-700">
                  Stop
                </button>
                <button onclick="openServiceURL('vscode')" id="vscode-open-btn"
                  class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
                  <i class="fas fa-external-link-alt"></i> Open
                </button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i class="fas fa-book text-purple-600"></i>
                <div>
                  <div class="font-semibold">Jupyter Notebook</div>
                  <div id="jupyter-service-status" class="text-sm text-gray-600"></div>
                  <div id="jupyter-execution-status" class="text-xs text-gray-500"></div>
                </div>
              </div>
              <div class="flex gap-2">
                <!-- Shown when execution NOT approved -->
                <button onclick="requestJupyterExecution()" id="jupyter-request-btn"
                  class="px-3 py-1 text-sm rounded bg-yellow-100 hover:bg-yellow-200 border border-yellow-400 text-yellow-700 hidden">
                  <i class="fas fa-lock"></i> Request GPU Access
                </button>
                <!-- Shown when execution IS approved -->
                <button onclick="startService('jupyter')" id="jupyter-start-btn"
                  class="px-3 py-1 text-sm rounded bg-green-100 hover:bg-green-200 border border-green-300 text-green-700">
                  Start
                </button>
                <button onclick="stopService('jupyter')" id="jupyter-stop-btn"
                  class="px-3 py-1 text-sm rounded bg-red-100 hover:bg-red-200 border border-red-300 text-red-700">
                  Stop
                </button>
                <button onclick="openServiceURL('jupyter')" id="jupyter-open-btn"
                  class="px-3 py-1 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
                  <i class="fas fa-external-link-alt"></i> Open
                </button>
              </div>
            </div>

            <!-- SSH Access Section -->
            <div class="flex items-center justify-between border-t pt-3 mt-3">
              <div class="flex items-center gap-3">
                <i class="fas fa-terminal text-green-600"></i>
                <div>
                  <div class="font-semibold">SSH Access</div>
                  <div id="ssh-service-status" class="text-sm text-gray-600">Direct terminal access</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="toggleSSHDropdown()" id="ssh-info-btn"
                  class="px-3 py-1 text-sm rounded bg-green-600 text-white hover:bg-green-700">
                  <i class="fas fa-key"></i> Connect
                </button>
              </div>
            </div>

            <!-- SSH Connection Dropdown -->
            <div id="ssh-dropdown" class="hidden mt-3 bg-gray-50 rounded-lg p-4 border">
              <h5 class="font-semibold text-gray-800 mb-3"><i class="fas fa-terminal"></i> SSH Connection</h5>

              <!-- SSH Command -->
              <div class="mb-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">SSH Command</label>
                <div class="flex items-center gap-2">
                  <code id="ssh-command" class="flex-1 bg-white border rounded px-3 py-2 text-sm font-mono text-gray-800 select-all">
                    Loading...
                  </code>
                  <button onclick="copySSHCommand()" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" title="Copy">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>

              <!-- Download Key Section -->
              <div class="mb-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">SSH Private Key</label>
                <div class="flex items-center gap-2">
                  <button onclick="downloadSSHKey()" id="download-key-btn"
                    class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-sm">
                    <i class="fas fa-download"></i> Download Key
                  </button>
                  <button onclick="regenerateSSHKey()" id="regenerate-key-btn"
                    class="px-3 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600 text-sm" title="Generate new key pair">
                    <i class="fas fa-sync"></i> Regenerate
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Save the key to <code class="bg-gray-200 px-1">~/.ssh/</code> and set permissions with <code class="bg-gray-200 px-1">chmod 600</code></p>
              </div>

              <!-- Quick Setup Instructions -->
              <details class="mt-3">
                <summary class="cursor-pointer text-sm font-medium text-blue-600 hover:text-blue-800">
                  <i class="fas fa-info-circle"></i> Setup Instructions
                </summary>
                <div class="mt-2 text-xs text-gray-600 space-y-2 bg-white rounded p-3 border">
                  <p><strong>1. Download your private key</strong> using the button above.</p>
                  <p><strong>2. Save the key file:</strong></p>
                  <code class="block bg-gray-100 p-2 rounded">
                    # Linux/Mac<br>
                    mv ~/Downloads/<%= user.email.split('@')[0] %>_hydra_key ~/.ssh/<br>
                    chmod 600 ~/.ssh/<%= user.email.split('@')[0] %>_hydra_key
                  </code>
                  <p><strong>3. Connect:</strong></p>
                  <code id="ssh-setup-command" class="block bg-gray-100 p-2 rounded">
                    ssh -i ~/.ssh/<%= user.email.split('@')[0] %>_hydra_key <%= user.email.split('@')[0] %>@hydra.newpaltz.edu -p 2222
                  </code>
                  <p class="text-yellow-600"><i class="fas fa-exclamation-triangle"></i> Windows users: Use PuTTY or Windows Terminal with OpenSSH</p>
                </div>
              </details>

              <div id="ssh-message" class="mt-2"></div>
            </div>
          </div>
        </div>

        <!-- Port Routing Section -->
        <div id="routing-section" class="mb-6 border rounded p-4 hidden">
          <h4 class="text-lg font-semibold mb-3"><i class="fas fa-route"></i> Port Routing</h4>
          <div class="overflow-x-auto mb-4">
            <table class="w-full text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left">Endpoint</th>
                  <th class="px-3 py-2 text-left">Port</th>
                  <th class="px-3 py-2 text-left">Type</th>
                  <th class="px-3 py-2 text-left">URL</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="routes-tbody" class="divide-y">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Auto-Discovery Info Section -->
          <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
            <h5 class="font-semibold text-blue-800 mb-1"><i class="fas fa-info-circle"></i> Auto-Discovery</h5>
            <p class="text-xs text-blue-700 mb-2">
              You can add special comments to your supervisor configs to enable auto-discovery of services:
            </p>
            <div class="bg-white rounded border border-blue-100 p-2 font-mono text-xs text-gray-700 mb-2">
              <div># hydra.port=3000</div>
              <div># hydra.endpoint=myapp</div>
            </div>
            <p class="text-xs text-blue-700">
              Click "Discover Services" below to scan your supervisor.d configs and find services that can be routed.
            </p>
          </div>

          <!-- Discover Services Section -->
          <div class="border-t pt-4 mb-4">
            <div class="flex items-center justify-between mb-3">
              <h5 class="font-semibold"><i class="fas fa-search"></i> Service Discovery</h5>
              <button onclick="discoverServices()" id="discover-btn"
                class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">
                <i class="fas fa-radar" id="discover-icon"></i> Discover Services
              </button>
            </div>
            <div id="discover-message" class="mb-3"></div>
            <div id="discovered-services" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-indigo-50">
                    <tr>
                      <th class="px-3 py-2 text-left">Service</th>
                      <th class="px-3 py-2 text-left">Port</th>
                      <th class="px-3 py-2 text-left">Endpoint</th>
                      <th class="px-3 py-2 text-left">Status</th>
                      <th class="px-3 py-2 text-left">Action</th>
                    </tr>
                  </thead>
                  <tbody id="discovered-tbody" class="divide-y">
                    <!-- Populated by JavaScript -->
                  </tbody>
                </table>
              </div>
              <p id="no-services-found" class="text-gray-500 text-sm py-3 hidden">
                No discoverable services found. Add hydra comments to your supervisor configs to enable discovery.
              </p>
            </div>
          </div>

          <div class="border-t pt-4">
            <h5 class="font-semibold mb-2">Add Custom Route</h5>
            <div class="flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-xs font-medium mb-1" for="new-endpoint">Endpoint</label>
                <input type="text" id="new-endpoint" placeholder="myapp"
                  class="w-full rounded border border-gray-300 px-3 py-2 text-sm" />
              </div>
              <div class="flex-1">
                <label class="block text-xs font-medium mb-1" for="new-port">Port</label>
                <input type="number" id="new-port" placeholder="3000" min="1024" max="65535"
                  class="w-full rounded border border-gray-300 px-3 py-2 text-sm" />
              </div>
              <button onclick="addRoute()"
                class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
                <i class="fas fa-plus"></i> Add
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Route your container's internal ports to custom endpoints. Reserved ports: 8443 (VS Code), 8888 (Jupyter).</p>
          </div>
          <div id="routing-message" class="mt-3"></div>
        </div>

        <!-- Server Status Section (Collapsible) -->
        <details id="server-status-section" class="mb-6 border rounded hidden group">
          <summary class="p-4 cursor-pointer hover:bg-gray-50 flex items-center justify-between">
            <h4 class="text-lg font-semibold">
              <i class="fas fa-server text-purple-600"></i> Server Status
            </h4>
            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
          </summary>
          <div class="p-4 pt-0 grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Hydra Status -->
            <div class="border rounded p-3 bg-gray-50">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-[#052049]">Hydra</span>
                <span id="hydra-status-badge" class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Online</span>
              </div>
              <p class="text-xs text-gray-500 mb-2">Control Plane</p>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">CPU:</span>
                  <span id="hydra-cpu" class="font-mono">--%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">RAM:</span>
                  <span id="hydra-ram" class="font-mono">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Disk:</span>
                  <span id="hydra-disk" class="font-mono">--</span>
                </div>
              </div>
            </div>

            <!-- Chimera Status -->
            <div class="border rounded p-3 bg-gray-50">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-[#052049]">Chimera</span>
                <span id="chimera-status-badge" class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Online</span>
              </div>
              <p class="text-xs text-gray-500 mb-2">Inference Node</p>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">CPU:</span>
                  <span id="chimera-cpu" class="font-mono">--%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">RAM:</span>
                  <span id="chimera-ram" class="font-mono">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Disk:</span>
                  <span id="chimera-disk" class="font-mono">--</span>
                </div>
              </div>
            </div>

            <!-- Cerberus Status -->
            <div class="border rounded p-3 bg-gray-50">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-[#052049]">Cerberus</span>
                <span id="cerberus-status-badge" class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Online</span>
              </div>
              <p class="text-xs text-gray-500 mb-2">Training Node</p>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">CPU:</span>
                  <span id="cerberus-cpu" class="font-mono">--%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">RAM:</span>
                  <span id="cerberus-ram" class="font-mono">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Disk:</span>
                  <span id="cerberus-disk" class="font-mono">--</span>
                </div>
              </div>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-3 px-4 pb-2">
            <i class="fas fa-info-circle"></i>
            <a href="/servers" target="_blank" class="text-blue-600 underline">View full cluster status</a>
          </p>
        </details>

        <!-- Backup Warning -->
        <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-amber-600 mt-0.5"></i>
            <div>
              <h5 class="font-semibold text-amber-800 mb-1">Development Environment Notice</h5>
              <p class="text-sm text-amber-700">
                This is a development environment and <strong>you are responsible for backing up your files</strong>.
                Container data may be wiped at the end of the semester. Make sure to create repos using git and backup to
                <a href="https://code.visualstudio.com/docs/sourcecontrol/github" target="_blank" class="text-blue-600 underline font-medium">GitHub</a>
                or on your own device.
              </p>
            </div>
          </div>
        </div>

        <!-- FAQ Section -->
        <div class="mt-6 border rounded-lg">
          <h4 class="text-lg font-semibold p-4 border-b bg-gray-50 rounded-t-lg">
            <i class="fas fa-question-circle text-blue-600"></i> Frequently Asked Questions
          </h4>
          <div class="divide-y">
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">What is this site?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                <p class="mb-3">Hydra Lab is the SUNY New Paltz Computer Science department's cloud computing platform. It provides students and faculty with personal development environments, AI tools, and computing resources for coursework and projects.</p>

                <p class="font-semibold mb-2">Services in your container:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li><strong>VS Code (code-server)</strong> - Full IDE in your browser</li>
                  <li><strong>Jupyter Lab</strong> - Interactive Python notebooks</li>
                  <li><strong>SSH Server</strong> - Connect at <code class="bg-gray-100 px-1 rounded">hydra.newpaltz.edu:2222</code></li>
                  <li><strong>Jenkins</strong> - CI/CD automation server</li>
                  <li><strong>10GB Persistent Storage</strong> - RAID-backed, persists between sessions</li>
                </ul>

                <p class="mt-3 font-semibold mb-2">Programming Languages:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Python 3</strong> - with pip, venv, Jupyter kernel</li>
                  <li><strong>Node.js 20</strong> - with nvm, npm, pnpm</li>
                  <li><strong>Java JDK 21</strong> - full development kit</li>
                  <li><strong>C/C++</strong> - GCC, G++, Clangd language server</li>
                  <li><strong>LCC Assembly</strong> - lcc, lcc-sim, ilcc (interactive debugger)</li>
                </ul>

                <p class="mt-3 font-semibold mb-2">Build & Dev Tools:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Build:</strong> CMake, Make, GDB (debugger)</li>
                  <li><strong>Version Control:</strong> Git</li>
                  <li><strong>Containers:</strong> Docker CLI, docker-compose, buildx</li>
                  <li><strong>Editors:</strong> nano, vim</li>
                </ul>

                <p class="mt-3 font-semibold mb-2">VS Code Extensions (pre-installed):</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Languages:</strong> Python, Java (RedHat + Debug + Test + Maven), C/C++ (Clangd), LCC Tools</li>
                  <li><strong>Web Dev:</strong> ESLint, Prettier, Live Server, HTML/CSS, React snippets</li>
                  <li><strong>Database:</strong> SQLTools (MySQL, PostgreSQL, SQLite drivers)</li>
                  <li><strong>CI/CD:</strong> Jenkins Pipeline, Groovy, GitHub Actions</li>
                  <li><strong>Other:</strong> Docker, PDF Viewer, LaTeX Workshop, Hex Editor, Code Runner</li>
                </ul>

                <p class="mt-3 font-semibold mb-2">Platform Services (outside container):</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Open WebUI</strong> - Chat with AI models, generate OpenAI-compatible API keys</li>
                  <li><strong>n8n</strong> - Visual workflow automation for APIs</li>
                  <li><strong>Port Routing</strong> - Expose your web apps with secure URLs</li>
                </ul>
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">How do I access my development container?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Click "Initialize Container" to create your personal development environment. Once running, click "Open VS Code" to access a full IDE in your browser with your files, terminal, and extensions pre-configured. You can also use "Open Jupyter" for notebook-based development, or connect via SSH at <code class="bg-gray-100 px-1 rounded">ssh yournetid@hydra.newpaltz.edu -p 2222</code>.
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">What tools are available in my container?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Your container includes Python 3, Node.js (with pnpm), Java JDK 21, GCC/G++, GDB, NASM (for assembly), CMake, Make, Git, and Docker CLI. Text editors include nano and vim. VS Code comes pre-configured with extensions for C/C++, Python, Java, Go, x86 Assembly, and more.
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">How do I expose a port for my web app?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Use the Port Routing section to add a port. Enter your app's port number (e.g., 3000, 8080) and click "Add Route". Your app will be accessible at the generated URL. Routes are automatically secured with your login.
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">What is Open WebUI?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Open WebUI provides access to AI language models hosted on the Hydra cluster. You can chat with models, generate API keys for personal projects, and experiment with LLMs. Go to <strong>Settings &gt; Account</strong> in Open WebUI to get your API key—it's OpenAI-compatible, so you can use it with standard libraries. <em>Note: Always follow your course's academic integrity policies when using AI tools.</em>
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">How do I back up my work?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Use Git to push your code to GitHub. In VS Code, open the Source Control panel (Ctrl+Shift+G), initialize a repo, commit your changes, and push to a remote repository. See the <a href="https://code.visualstudio.com/docs/sourcecontrol/github" target="_blank" class="text-blue-600 underline">VS Code GitHub guide</a> for details.
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">Can I request a service to be hosted for the lab or department?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                Yes! If you have a service that would benefit the CS lab or department (research tools, course-specific software, etc.), please contact the <a href="mailto:compsci@newpaltz.edu" class="text-blue-600 underline">department assistant</a> with your request.
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">How do Kubernetes pods work?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                <p class="mb-2">Pods are the smallest deployable unit in Kubernetes. Each pod contains one or more containers that share the same network namespace and storage volumes.</p>
                <p class="mb-2">Hydra uses three Kubernetes namespaces:</p>
                <ul class="list-disc list-inside space-y-1 ml-2 mb-2">
                  <li><strong>hydra-system</strong> — Core platform services (auth, proxy, registry)</li>
                  <li><strong>hydra-students</strong> — Student development containers</li>
                  <li><strong>hydra-infra</strong> — Faculty and department infrastructure services</li>
                </ul>
                <p class="mb-2">Each pod gets its own IP address within the cluster and can have persistent storage via PersistentVolumeClaims (PVCs) backed by the RAID array. Pods are managed by Deployments, which handle scaling, rolling updates, and automatic restarts if a pod crashes.</p>
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">How do I create a pod or deploy a service?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                <p class="mb-2"><strong>Students:</strong> Click the "Initialize Container" button on the Containers tab. This creates a personal development pod with VS Code, Jupyter, and SSH pre-configured.</p>
                <p class="mb-2"><strong>Faculty / Admins:</strong> Use the "Infra Services" tab to deploy from Docker Compose, a GitHub repo, or raw Kubernetes YAML. Docker Compose files are automatically converted to Kubernetes manifests. Named volumes in your Compose file become PersistentVolumeClaims backed by RAID storage.</p>
              </div>
            </details>
            <details class="group">
              <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                <span class="font-medium">Can I run containers inside my container?</span>
                <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
              </summary>
              <div class="px-4 pb-4 text-sm text-gray-600">
                <p class="mb-2">Yes! Student containers include the Docker CLI. You can build and run containers within your pod using Docker-in-Docker (DinD).</p>
                <p class="mb-2">Use <code class="bg-gray-100 px-1 rounded">docker build</code> to create images and <code class="bg-gray-100 px-1 rounded">docker run</code> to launch containers. For persistent images, push to the Hydra registry at <code class="bg-gray-100 px-1 rounded">hydra.newpaltz.edu:5000</code>.</p>
              </div>
            </details>
          </div>
        </div>
      </section>

      <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
      <section id="panel-infra" class="hidden">
        <!-- Header Row -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold"><i class="fas fa-server text-blue-600"></i> Infrastructure Services</h3>
          <button onclick="document.getElementById('infra-deploy-modal').classList.remove('hidden')"
            class="inline-flex items-center px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-sm font-medium">
            <i class="fas fa-plus mr-2"></i> Deploy New Service
          </button>
        </div>

        <!-- Service Grid -->
        <div id="infra-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="text-center py-8 text-gray-500 col-span-full">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading infrastructure services...</p>
          </div>
        </div>

        <!-- Deploy Modal -->
        <div id="infra-deploy-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-4 sm:top-10 mx-auto p-3 sm:p-5 border w-[95%] sm:w-11/12 max-w-lg sm:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-rocket text-green-600"></i> Deploy New Service</h3>
              <button onclick="document.getElementById('infra-deploy-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>

            <!-- Deploy Sub-Tabs -->
            <div class="flex border-b mb-4">
              <button id="deploy-tab-compose" onclick="switchDeployTab('compose')" class="px-4 py-2 -mb-px border-b-2 border-blue-600 text-blue-600 font-medium text-sm">
                <i class="fas fa-file-code mr-1"></i> Docker Compose
              </button>
              <button id="deploy-tab-github" onclick="switchDeployTab('github')" class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm">
                <i class="fab fa-github mr-1"></i> GitHub Repo
              </button>
              <button id="deploy-tab-manifest" onclick="switchDeployTab('manifest')" class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm">
                <i class="fas fa-dharmachakra mr-1"></i> K8s YAML
              </button>
            </div>

            <!-- Docker Compose Sub-Panel -->
            <div id="deploy-panel-compose">
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Service Name</label>
                <input type="text" id="compose-service-name" placeholder="e.g. my-web-app"
                  class="w-full px-3 py-2 border rounded text-sm" />
              </div>
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Docker Compose YAML</label>
                <textarea id="compose-yaml" rows="10" placeholder="version: '3'&#10;services:&#10;  web:&#10;    image: nginx:latest&#10;    ports:&#10;      - '80:80'"
                  class="w-full px-3 py-2 border rounded text-sm font-mono"></textarea>
              </div>
              <button onclick="deployFromCompose()" class="w-full px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium">
                <i class="fas fa-upload mr-1"></i> Deploy from Compose
              </button>
            </div>

            <!-- GitHub Repo Sub-Panel -->
            <div id="deploy-panel-github" class="hidden">
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Repository URL</label>
                <input type="url" id="github-repo-url" placeholder="https://github.com/user/repo"
                  class="w-full px-3 py-2 border rounded text-sm" />
              </div>
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Branch (optional)</label>
                <input type="text" id="github-branch" placeholder="main"
                  class="w-full px-3 py-2 border rounded text-sm" />
              </div>
              <button onclick="deployFromGithub()" class="w-full px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium">
                <i class="fab fa-github mr-1"></i> Deploy from GitHub
              </button>
            </div>

            <!-- K8s YAML Sub-Panel -->
            <div id="deploy-panel-manifest" class="hidden">
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Kubernetes Manifests (YAML)</label>
                <textarea id="k8s-manifest" rows="12" placeholder="apiVersion: apps/v1&#10;kind: Deployment&#10;metadata:&#10;  name: my-app&#10;spec:&#10;  replicas: 1&#10;  ..."
                  class="w-full px-3 py-2 border rounded text-sm font-mono"></textarea>
              </div>
              <button onclick="deployFromManifest()" class="w-full px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium">
                <i class="fas fa-dharmachakra mr-1"></i> Deploy Manifest
              </button>
            </div>

            <div id="deploy-message" class="mt-3"></div>
          </div>
        </div>

        <!-- Logs Modal -->
        <div id="infra-logs-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-4 sm:top-10 mx-auto p-3 sm:p-5 border w-[95%] sm:w-11/12 max-w-lg sm:max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-scroll text-purple-600"></i> Service Logs — <span id="infra-logs-title"></span></h3>
              <button onclick="document.getElementById('infra-logs-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <pre id="infra-logs-output" class="bg-gray-900 text-green-400 p-4 rounded text-xs font-mono overflow-auto max-h-96 whitespace-pre-wrap">Loading logs...</pre>
          </div>
        </div>

        <!-- Service Detail Modal -->
        <div id="infra-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-4 sm:top-10 mx-auto p-3 sm:p-5 border w-[95%] sm:w-11/12 max-w-lg sm:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-gray-900"><i class="fas fa-info-circle text-blue-600"></i> Service Details — <span id="infra-detail-title"></span></h3>
              <button onclick="document.getElementById('infra-detail-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div id="infra-detail-content" class="space-y-4">
              <p class="text-gray-500 text-center">Loading details...</p>
            </div>
          </div>
        </div>
      </section>
      <% } %>

    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-800 border-t border-slate-700 py-4 mt-8">
    <div class="text-center">
      <a href="https://github.com/compsci-suny-newpaltz" target="_blank" rel="noopener noreferrer"
         class="text-slate-400 hover:text-white transition-colors text-sm">
        Made by: SUNY Hydra Lab Team 2026 @ SUNY New Paltz
      </a>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const email = "<%= user.email %>";
      const name = "<%= user.firstName %> <%= user.lastName %>";
      const oid = "<%= user.oid %>";

      // Check if user exists in OpenWebUI
      checkUserExists(email, name);

      // Setup form handlers
      document.getElementById('create-account-form').addEventListener('submit', function (e) {
        e.preventDefault();
        createAccount(email, name);
      });

      document.getElementById('change-password-form').addEventListener('submit', function (e) {
        e.preventDefault();
        changePassword(email);
      });

      // Tabs
      const tabs = [
        { btn: 'tab-containers', panel: 'panel-containers' },
        { btn: 'tab-openwebui', panel: 'panel-openwebui' },
        { btn: 'tab-n8n', panel: 'panel-n8n' },
        { btn: 'tab-minecraft', panel: 'panel-minecraft' }
      ];
      <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
      tabs.push({ btn: 'tab-infra', panel: 'panel-infra' });
      <% } %>
      tabs.forEach(t => {
        document.getElementById(t.btn).addEventListener('click', () => {
          tabs.forEach(x => {
            document.getElementById(x.btn).classList.remove('border-b-2', 'border-[#052049]', 'text-[#052049]');
            document.getElementById(x.btn).classList.add('text-gray-600');
            document.getElementById(x.panel).classList.add('hidden');
          });
          document.getElementById(t.btn).classList.add('border-b-2', 'border-[#052049]', 'text-[#052049]');
          document.getElementById(t.btn).classList.remove('text-gray-600');
          document.getElementById(t.panel).classList.remove('hidden');
        });
      });

      // ==================== Dark Mode Toggle ====================
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const darkModeIcon = document.getElementById('dark-mode-icon');

      function updateDarkModeIcon() {
        const isDark = document.body.classList.contains('dark');
        darkModeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        darkModeToggle.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
      }

      // Initialize icon based on current state
      updateDarkModeIcon();

      darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        localStorage.setItem('hydra_dark_mode', isDark);
        updateDarkModeIcon();
      });

      // System preference changes no longer auto-switch - user must explicitly toggle
      // Dark mode preference is saved in localStorage and persists across sessions

      // Easter egg: Click cat 20 times to reveal Minecraft tab
      let catClicks = 0;
      const hydraCat = document.getElementById('hydra-cat');
      const minecraftTab = document.getElementById('tab-minecraft');
      hydraCat.addEventListener('click', () => {
        catClicks++;
        if (catClicks >= 20 && minecraftTab.classList.contains('hidden')) {
          minecraftTab.classList.remove('hidden');
          hydraCat.style.animation = 'spin 0.5s ease-out';
          setTimeout(() => hydraCat.style.animation = '', 500);
        } else if (catClicks < 20) {
          // Small bounce animation as feedback
          hydraCat.style.transform = 'scale(1.2)';
          setTimeout(() => hydraCat.style.transform = '', 100);
        }
      });

      // Centralized API helper with 401 redirect
      let authRedirectInProgress = false;
      function handleAuthError(res) {
        if (res && res.status === 401) {
          if (!authRedirectInProgress) {
            authRedirectInProgress = true;
            window.location.href = '/login?returnTo=' + encodeURIComponent(window.location.pathname);
          }
          return true;
        }
        return false;
      }

      // Handle fetch errors (often caused by CORS on auth redirect)
      function handleFetchError(err) {
        if (err && err.message && err.message.includes('Failed to fetch') && !authRedirectInProgress) {
          console.warn('[Auth] Session may have expired, redirecting to login...');
          authRedirectInProgress = true;
          window.location.href = '/login?returnTo=' + encodeURIComponent(window.location.pathname);
          return true;
        }
        return false;
      }

      async function api(url, opts = {}) {
        try {
          const res = await fetch(url, opts);
          if (handleAuthError(res)) return null;
          if (!res.ok) throw new Error(await res.text());
          return await res.json();
        } catch (err) {
          if (handleFetchError(err)) return null;
          throw err;
        }
      }

      async function apiJson(url, opts = {}) {
        try {
          const res = await fetch(url, {
            ...opts,
            headers: { 'Content-Type': 'application/json', ...opts.headers }
          });
          if (handleAuthError(res)) return null;
          return res;
        } catch (err) {
          if (handleFetchError(err)) return null;
          throw err;
        }
      }
      async function loadMinecraftUsername() {
        try {
          const res = await fetch('/minecraftdashboard/api/my-username');
          if (res.status === 401) {
            window.location.href = '/logout?returnTo=https://hydra.newpaltz.edu/dashboard';
            return;
          }
          if (!res.ok) throw new Error(await res.text());
          const { minecraft_username } = await res.json();
          const input = document.getElementById('minecraft-username');
          input.value = minecraft_username || '';
          document.getElementById('minecraft-help').classList.toggle('hidden', !!minecraft_username);
        } catch {
          document.getElementById('minecraft-help').classList.remove('hidden');
        }
      }
      document.getElementById('minecraft-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const input = document.getElementById('minecraft-username');
        const username = input.value.trim();
        const msg = document.getElementById('minecraft-message');
        if (!username) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Please enter a Minecraft username.</p>';
          document.getElementById('minecraft-help').classList.remove('hidden');
          return;
        }
        try {
          await api('/minecraftdashboard/api/my-username', { method: 'POST', body: JSON.stringify({ minecraft_username: username }), headers: { 'Content-Type': 'application/json' } });
          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Username saved!</p>';
          document.getElementById('minecraft-help').classList.add('hidden');
        } catch (err) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Failed to save username.</p>';
        }
      });
      loadMinecraftUsername();

      // Copy Minecraft server URL to clipboard
      document.getElementById('copy-server-url').addEventListener('click', function () {
        const input = document.getElementById('minecraft-server-url');
        input.select();
        input.setSelectionRange(0, 99999); // For mobile
        document.execCommand('copy');
        this.textContent = 'Copied!';
        setTimeout(() => { this.textContent = 'Copy'; }, 1500);
      });

      // n8n: status + create flow
      checkN8nStatus();
      document.getElementById('n8n-create-form').addEventListener('submit', function (e) {
        e.preventDefault();
        createN8nAccount();
      });
      document.getElementById('n8n-change-password-form').addEventListener('submit', function (e) {
        e.preventDefault();
        changeN8nPassword();
      });

      // Container management - load status on page load (now default tab) and when tab is clicked
      let containerStatusInterval = null;

      // Load container status immediately since Containers is the default tab
      loadContainerStatus();
      containerStatusInterval = setInterval(loadContainerStatus, 5000);

      document.getElementById('tab-containers').addEventListener('click', () => {
        loadContainerStatus();
        // Start polling every 5 seconds
        if (containerStatusInterval) clearInterval(containerStatusInterval);
        containerStatusInterval = setInterval(loadContainerStatus, 5000);
      });

      // Stop polling when switching away from containers tab
      tabs.forEach(t => {
        if (t.btn !== 'tab-containers') {
          document.getElementById(t.btn).addEventListener('click', () => {
            if (containerStatusInterval) {
              clearInterval(containerStatusInterval);
              containerStatusInterval = null;
            }
          });
        }
      });

      // Container Management Functions
      let lastKnownResources = null; // Store actual K8s state for resource modal

      async function loadContainerStatus() {
        try {
          const res = await fetch('/dashboard/api/containers/status');
          if (handleAuthError(res)) return;
          const data = await res.json();

          // Check if migration is in progress (from server or local state)
          const migrationState = checkMigrationInProgress();
          // Always call handleMigrationStatus to check for server-side migration
          if (handleMigrationStatus(data, migrationState)) {
            // Migration in progress, skip normal UI update for state
            // But still update resources display
          }

          const badge = document.getElementById('container-state-badge');
          const notCreated = document.getElementById('container-not-created');
          const controls = document.getElementById('container-controls');
          const servicesSection = document.getElementById('services-section');
          const routingSection = document.getElementById('routing-section');
          const serverStatusSection = document.getElementById('server-status-section');
          const resourcesSection = document.getElementById('container-resources');

          // Update resource display
          if (data.resources) {
            lastKnownResources = data.resources; // Store for resource modal
            document.getElementById('res-cpu').textContent = data.resources.cpu || '-';
            document.getElementById('res-ram').textContent = data.resources.memory_gb ? data.resources.memory_gb + 'GB' : '-';
            document.getElementById('res-storage').textContent = data.resources.storage_gb ? data.resources.storage_gb + 'GB' : '-';
            document.getElementById('res-gpu').textContent = data.resources.gpu_count || '0';
            document.getElementById('res-node').textContent = data.resources.node || '-';
            resourcesSection.classList.remove('hidden');

            // Show migration banner if approved for GPU node but not yet migrated
            const migrationBanner = document.getElementById('migration-banner');
            if (data.resources.approved_target_node) {
              document.getElementById('migrate-target-node').textContent =
                data.resources.approved_target_node.charAt(0).toUpperCase() + data.resources.approved_target_node.slice(1);
              // Show GPU count if set, otherwise show "GPU access"
              const gpuCount = data.resources.gpu_count || 1;
              document.getElementById('migrate-gpu-count').textContent = gpuCount;
              migrationBanner.classList.remove('hidden');
              // Store target node for migration function
              window.approvedTargetNode = data.resources.approved_target_node;
            } else {
              migrationBanner.classList.add('hidden');
            }
          }

          if (!data.exists) {
            // Container not created
            badge.textContent = 'Not Created';
            badge.className = 'px-3 py-1 rounded text-sm font-medium bg-gray-200 text-gray-700';
            notCreated.classList.remove('hidden');
            controls.classList.add('hidden');
            servicesSection.classList.add('hidden');
            routingSection.classList.add('hidden');
            serverStatusSection.classList.add('hidden');
          } else {
            // Container exists
            notCreated.classList.add('hidden');
            controls.classList.remove('hidden');

            if (data.running) {
              badge.textContent = 'Running';
              badge.className = 'px-3 py-1 rounded text-sm font-medium bg-green-100 text-green-700';
              servicesSection.classList.remove('hidden');
              routingSection.classList.remove('hidden');
              serverStatusSection.classList.remove('hidden');

              // Load services, routes, and server status
              loadServices();
              loadRoutes();
              loadServerStatus();
            } else {
              badge.textContent = 'Stopped';
              badge.className = 'px-3 py-1 rounded text-sm font-medium bg-yellow-100 text-yellow-700';
              servicesSection.classList.add('hidden');
              routingSection.classList.add('hidden');
              serverStatusSection.classList.add('hidden');
            }
          }
        } catch (err) {
          if (handleFetchError(err)) return;
          console.error('[Container Status] Failed to load:', err);
          // Show error state in UI
          const badge = document.getElementById('container-state-badge');
          if (badge) {
            badge.textContent = 'Error';
            badge.className = 'px-3 py-1 rounded text-sm font-medium bg-red-100 text-red-700';
          }
        }
      }

      window.initContainer = async function () {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Initializing container (this may take up to 60s)...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/init', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          // Check if pod is actually ready
          if (data.ready === false) {
            msg.innerHTML = `<p class="text-yellow-700 bg-yellow-100 border border-yellow-200 rounded p-2"><i class="fas fa-exclamation-triangle mr-2"></i>Container created but not ready yet (${data.status || 'starting'}). Refresh in a moment.</p>`;
          } else {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2"><i class="fas fa-check-circle mr-2"></i>Container initialized and running!</p>';
          }
          setTimeout(() => { msg.innerHTML = ''; }, 5000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2"><i class="fas fa-times-circle mr-2"></i>${err.message || 'Failed to initialize'}</p>`;
        }
      };

      window.startContainer = async function () {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Starting container (this may take up to 60s)...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/start', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          // Check if pod is actually ready
          if (data.ready === false) {
            msg.innerHTML = `<p class="text-yellow-700 bg-yellow-100 border border-yellow-200 rounded p-2"><i class="fas fa-exclamation-triangle mr-2"></i>Container starting but not ready yet (${data.status || 'starting'}). Refresh in a moment.</p>`;
          } else {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2"><i class="fas fa-check-circle mr-2"></i>Container started and running!</p>';
          }
          setTimeout(() => { msg.innerHTML = ''; }, 5000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2"><i class="fas fa-times-circle mr-2"></i>${err.message || 'Failed to start'}</p>`;
        }
      };

      window.stopContainer = async function () {
        if (!confirm('Stop your container? Services will be unavailable until you start it again.')) return;
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Stopping container...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/stop', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container stopped!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to stop'}</p>`;
        }
      };

      window.restartContainer = async function () {
        if (!confirm('Restart your container? This will briefly interrupt your services.')) return;
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Restarting container...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/restart', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2"><i class="fas fa-check-circle mr-2"></i>Container restarted!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2"><i class="fas fa-times-circle mr-2"></i>${err.message || 'Failed to restart'}</p>`;
        }
      };

      window.showWipeModal = function () {
        document.getElementById('wipe-modal').classList.remove('hidden');
      };

      document.getElementById('cancel-wipe-btn').addEventListener('click', () => {
        document.getElementById('wipe-modal').classList.add('hidden');
      });

      document.getElementById('confirm-wipe-btn').addEventListener('click', () => {
        document.getElementById('wipe-modal').classList.add('hidden');
        wipeContainer();
      });

      async function wipeContainer() {
        const msg = document.getElementById('container-message');
        msg.innerHTML = '<p class="text-gray-600">Wiping container volume and recreating...</p>';
        try {
          const res = await fetch('/dashboard/api/containers/wipe', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Container wiped and recreated successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 5000);
          loadContainerStatus();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to wipe container'}</p>`;
        }
      }

      // GPU Migration Functions
      // Check if migration is in progress (persists across page refresh)
      function checkMigrationInProgress() {
        const migrationState = localStorage.getItem('hydra_migration_in_progress');
        if (migrationState) {
          try {
            const state = JSON.parse(migrationState);
            // Check if migration started within the last 10 minutes
            if (state.startTime && (Date.now() - state.startTime) < 600000) {
              return state;
            } else {
              // Migration timed out, clear state
              localStorage.removeItem('hydra_migration_in_progress');
            }
          } catch (e) {
            localStorage.removeItem('hydra_migration_in_progress');
          }
        }
        return null;
      }

      // Migration timer state
      let migrationTimerInterval = null;
      const MIGRATION_ESTIMATED_SECONDS = 120; // 2 minutes estimated migration time

      // Show migration in progress UI with countdown timer and progress bar
      function showMigrationProgress(targetNode, startTime = null) {
        const msg = document.getElementById('container-message');
        const migrateBtn = document.getElementById('migrate-btn');
        const migrationBanner = document.getElementById('migration-banner');

        if (migrateBtn) {
          migrateBtn.disabled = true;
          migrateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Migrating...';
        }
        if (migrationBanner) {
          migrationBanner.classList.remove('hidden');
        }

        // Calculate elapsed time if startTime provided
        const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
        const remaining = Math.max(0, MIGRATION_ESTIMATED_SECONDS - elapsed);

        msg.innerHTML = `
          <div class="text-blue-600 bg-blue-50 border border-blue-200 rounded p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-sync fa-spin mr-2"></i>
              <span>Migrating container to <strong>${targetNode || 'GPU node'}</strong>...</span>
            </div>
            <div class="mb-2">
              <div class="flex justify-between text-sm mb-1">
                <span id="migration-status-text">Preparing migration...</span>
                <span id="migration-timer">${formatMigrationTime(remaining)} remaining</span>
              </div>
              <div class="w-full bg-blue-200 rounded-full h-2.5">
                <div id="migration-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000" style="width: ${Math.min(100, (elapsed / MIGRATION_ESTIMATED_SECONDS) * 100)}%"></div>
              </div>
            </div>
            <p class="text-xs text-blue-500 mt-2">
              <i class="fas fa-info-circle mr-1"></i>
              Your files will be preserved. Please do not close this page.
            </p>
          </div>
        `;

        // Start or continue the timer
        startMigrationTimer(startTime || Date.now());
      }

      // Format seconds into mm:ss format
      function formatMigrationTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      // Start the migration countdown timer
      function startMigrationTimer(startTime) {
        // Clear any existing timer
        if (migrationTimerInterval) {
          clearInterval(migrationTimerInterval);
        }

        migrationTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const remaining = Math.max(0, MIGRATION_ESTIMATED_SECONDS - elapsed);
          const progress = Math.min(100, (elapsed / MIGRATION_ESTIMATED_SECONDS) * 100);

          const timerEl = document.getElementById('migration-timer');
          const progressBar = document.getElementById('migration-progress-bar');
          const statusText = document.getElementById('migration-status-text');

          if (timerEl) {
            if (remaining > 0) {
              timerEl.textContent = `${formatMigrationTime(remaining)} remaining`;
            } else {
              timerEl.textContent = 'Finishing up...';
            }
          }

          if (progressBar) {
            progressBar.style.width = `${progress}%`;
          }

          // Update status text based on progress
          if (statusText) {
            if (elapsed < 10) {
              statusText.textContent = 'Preparing migration...';
            } else if (elapsed < 30) {
              statusText.textContent = 'Stopping current container...';
            } else if (elapsed < 60) {
              statusText.textContent = 'Transferring configuration...';
            } else if (elapsed < 90) {
              statusText.textContent = 'Creating container on new node...';
            } else if (elapsed < 110) {
              statusText.textContent = 'Starting container with GPU access...';
            } else {
              statusText.textContent = 'Finalizing migration...';
            }
          }
        }, 1000);
      }

      // Stop the migration timer
      function stopMigrationTimer() {
        if (migrationTimerInterval) {
          clearInterval(migrationTimerInterval);
          migrationTimerInterval = null;
        }
      }

      // Clear migration progress state and stop the timer
      function clearMigrationProgress() {
        localStorage.removeItem('hydra_migration_in_progress');
        stopMigrationTimer();
      }

      // Check for migration completion based on container status
      function handleMigrationStatus(data, migrationState) {
        const msg = document.getElementById('container-message');
        const migrateBtn = document.getElementById('migrate-btn');
        const migrationBanner = document.getElementById('migration-banner');

        // Check if server reports active migration
        if (data.migration && data.migration.inProgress) {
          // Use real progress from server
          showRealMigrationProgress(data.migration);
          return true;
        }

        if (!migrationState) return false;

        // If container is now running on the target node, migration is complete
        if (data.exists && data.running && data.resources &&
            data.resources.node === migrationState.targetNode) {
          clearMigrationProgress();
          msg.innerHTML = `
            <p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">
              <i class="fas fa-check-circle mr-2"></i>
              Container successfully migrated to ${migrationState.targetNode}!
            </p>
          `;
          if (migrationBanner) migrationBanner.classList.add('hidden');
          setTimeout(() => { msg.innerHTML = ''; }, 5000);
          // Refresh pending requests to clear the approved request from UI
          loadPendingRequests();
          return true;
        }

        // If still pending/not running, keep showing progress with the original start time
        showMigrationProgress(migrationState.targetNode, migrationState.startTime);
        return true;
      }

      // Show real-time migration progress from server
      function showRealMigrationProgress(migration) {
        const msg = document.getElementById('container-message');
        const migrationBanner = document.getElementById('migration-banner');

        // Hide the migrate banner if showing
        if (migrationBanner) {
          migrationBanner.classList.add('hidden');
        }

        // Stop any timer-based progress
        stopMigrationTimer();

        msg.innerHTML = `
          <div class="text-blue-600 bg-blue-50 border border-blue-200 rounded p-4">
            <div class="flex items-center mb-3">
              <span class="text-xl mr-2">${migration.stepIcon}</span>
              <span>Migrating container to <strong>${migration.toNode || 'GPU node'}</strong></span>
            </div>
            <div class="mb-2">
              <div class="flex justify-between text-sm mb-1">
                <span id="migration-status-text">${migration.stepLabel}</span>
                <span id="migration-progress-percent">${migration.progressPercent}%</span>
              </div>
              <div class="w-full bg-blue-200 rounded-full h-2.5">
                <div id="migration-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: ${migration.progressPercent}%"></div>
              </div>
            </div>
            <p class="text-xs text-blue-500 mt-2">
              <i class="fas fa-info-circle mr-1"></i>
              Your files will be preserved. Page will refresh when complete.
            </p>
          </div>
        `;

        // Set up polling for migration status
        if (!window.migrationPollInterval) {
          window.migrationPollInterval = setInterval(async () => {
            try {
              const res = await fetch('/dashboard/api/containers/status');
              if (res.ok) {
                const data = await res.json();
                if (data.migration && data.migration.inProgress) {
                  // Update progress bar and status
                  const statusText = document.getElementById('migration-status-text');
                  const progressPercent = document.getElementById('migration-progress-percent');
                  const progressBar = document.getElementById('migration-progress-bar');
                  if (statusText) statusText.textContent = data.migration.stepLabel;
                  if (progressPercent) progressPercent.textContent = data.migration.progressPercent + '%';
                  if (progressBar) progressBar.style.width = data.migration.progressPercent + '%';
                } else {
                  // Migration complete - refresh the page
                  clearInterval(window.migrationPollInterval);
                  window.migrationPollInterval = null;
                  clearMigrationProgress();
                  location.reload();
                }
              }
            } catch (err) {
              console.error('Migration poll error:', err);
            }
          }, 2000); // Poll every 2 seconds
        }
      }

      window.migrateContainer = async function() {
        const targetNode = window.approvedTargetNode;
        if (!targetNode) {
          alert('No approved target node found. Please wait for admin approval.');
          return;
        }

        const confirmed = confirm(
          `This will migrate your container to ${targetNode} with GPU access.\n\n` +
          `Your container will be stopped on the current node and recreated on ${targetNode}.\n` +
          `All your files will be preserved.\n\n` +
          `This may take a few minutes. Continue?`
        );

        if (!confirmed) return;

        const msg = document.getElementById('container-message');
        const migrateBtn = document.getElementById('migrate-btn');

        // Save migration state to localStorage for persistence across page refresh
        const startTime = Date.now();
        localStorage.setItem('hydra_migration_in_progress', JSON.stringify({
          targetNode: targetNode,
          startTime: startTime
        }));

        // Disable button and show progress with timer
        showMigrationProgress(targetNode, startTime);

        try {
          const res = await fetch('/dashboard/api/containers/migrate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target_node: targetNode })
          });

          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!res.ok || !data.success) {
            throw new Error(data.message || 'Migration failed');
          }

          // Clear migration state from localStorage on success
          clearMigrationProgress();

          msg.innerHTML = `
            <p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">
              <i class="fas fa-check-circle mr-2"></i>
              Container successfully migrated to ${targetNode}!
              ${data.gpu_count ? `<br><small class="text-green-600">${data.gpu_count} GPU(s) now available</small>` : ''}
            </p>
          `;

          // Hide migration banner after successful migration
          const migrationBanner = document.getElementById('migration-banner');
          if (migrationBanner) {
            migrationBanner.classList.add('hidden');
          }

          // Refresh pending requests to clear the approved request from UI
          loadPendingRequests();

          // Refresh container status
          setTimeout(() => {
            msg.innerHTML = '';
            loadContainerStatus();
          }, 3000);

        } catch (err) {
          // Clear migration state on error
          clearMigrationProgress();

          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2"><i class="fas fa-exclamation-triangle mr-2"></i>${err.message || 'Failed to migrate container'}</p>`;

          // Re-enable button on error
          if (migrateBtn) {
            migrateBtn.disabled = false;
            migrateBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Migrate Now';
          }

          // Refresh container status and pending requests after error
          setTimeout(() => {
            loadContainerStatus();
            loadPendingRequests();
          }, 3000);
        }
      };

      // Jupyter Execution Approval Functions
      let jupyterExecutionApproved = false;

      async function checkJupyterExecutionStatus() {
        try {
          const res = await fetch('/dashboard/api/containers/jupyter-status');
          if (handleAuthError(res)) return;
          const data = await res.json();

          jupyterExecutionApproved = data.jupyter_execution_approved;
          const statusEl = document.getElementById('jupyter-execution-status');
          const requestBtn = document.getElementById('jupyter-request-btn');
          const startBtn = document.getElementById('jupyter-start-btn');
          const stopBtn = document.getElementById('jupyter-stop-btn');

          if (data.jupyter_execution_approved) {
            statusEl.textContent = 'Execution enabled';
            statusEl.className = 'text-xs text-green-600';
            requestBtn?.classList.add('hidden');
            startBtn?.classList.remove('hidden');
            stopBtn?.classList.remove('hidden');
          } else {
            statusEl.textContent = 'Edit only - execution requires approval';
            statusEl.className = 'text-xs text-yellow-600';
            requestBtn?.classList.remove('hidden');
            // Still allow start/open for editing notebooks
            startBtn?.classList.remove('hidden');
            stopBtn?.classList.remove('hidden');
          }
        } catch (err) {
          console.error('[jupyter] Status check failed:', err);
        }
      }

      window.requestJupyterExecution = async function() {
        const reason = prompt('Why do you need Jupyter execution access? (e.g., ML course, data science project)');
        if (!reason) return;

        try {
          const res = await fetch('/dashboard/api/containers/jupyter-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
          });

          if (handleAuthError(res)) return;
          const data = await res.json();

          if (data.success) {
            if (data.already_approved) {
              alert('Jupyter execution is already approved for your account!');
              checkJupyterExecutionStatus();
            } else {
              alert('Request submitted! An admin will review your request and you will be notified.');
            }
          } else {
            alert(data.message || 'Failed to submit request');
          }
        } catch (err) {
          alert('Failed to submit Jupyter execution request: ' + err.message);
        }
      };

      // Check Jupyter status on load
      checkJupyterExecutionStatus();

      // SSH Access Functions
      window.toggleSSHDropdown = function() {
        const dropdown = document.getElementById('ssh-dropdown');
        dropdown.classList.toggle('hidden');
        if (!dropdown.classList.contains('hidden')) {
          loadSSHInfo();
        }
      };

      async function loadSSHInfo() {
        const commandEl = document.getElementById('ssh-command');
        const setupCommandEl = document.getElementById('ssh-setup-command');
        const msg = document.getElementById('ssh-message');

        try {
          const res = await fetch('/dashboard/api/containers/ssh-info');
          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!data.success || !data.sshPort) {
            commandEl.textContent = 'SSH not available - container not initialized';
            return;
          }

          commandEl.textContent = data.sshCommand;
          if (setupCommandEl) {
            setupCommandEl.textContent = data.sshCommand;
          }

          // Update status
          const statusEl = document.getElementById('ssh-service-status');
          if (statusEl) {
            statusEl.textContent = `Port ${data.sshPort} • ${data.hasKey ? 'Key available' : 'No key generated'}`;
          }
        } catch (err) {
          console.error('Failed to load SSH info:', err);
          commandEl.textContent = 'Error loading SSH info';
        }
      }

      window.copySSHCommand = function() {
        const commandEl = document.getElementById('ssh-command');
        navigator.clipboard.writeText(commandEl.textContent).then(() => {
          const msg = document.getElementById('ssh-message');
          msg.innerHTML = '<p class="text-green-600 text-sm"><i class="fas fa-check"></i> Copied to clipboard!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 2000);
        });
      };

      window.downloadSSHKey = function() {
        window.location.href = '/dashboard/api/containers/ssh-key';
      };

      window.regenerateSSHKey = async function() {
        if (!confirm('Generate new SSH keys? Your old key will no longer work and you will need to download the new key.')) return;

        const msg = document.getElementById('ssh-message');
        msg.innerHTML = '<p class="text-gray-600"><i class="fas fa-spinner fa-spin"></i> Regenerating keys...</p>';

        try {
          const res = await fetch('/dashboard/api/containers/ssh-key/regenerate', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-600"><i class="fas fa-check"></i> New keys generated! Download your new key below.</p>';
          loadSSHInfo();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-600"><i class="fas fa-exclamation-circle"></i> ${err.message}</p>`;
        }
      };

      // Resource Configuration Functions
      let resourceConfig = null;
      let pendingRequestId = null;
      let currentRecommendation = null;
      let selectedNode = 'hydra';

      window.showResourceModal = async function () {
        const modal = document.getElementById('resource-modal');
        const msg = document.getElementById('resource-modal-message');
        msg.innerHTML = '<p class="text-gray-600">Loading configuration...</p>';
        modal.classList.remove('hidden');

        try {
          // Load current configuration with node metrics
          const res = await fetch('/dashboard/api/resource-requests/presets');
          if (handleAuthError(res)) return;
          resourceConfig = await res.json();

          // Update current config display - use actual K8s state from lastKnownResources when available
          const resources = lastKnownResources || {};
          const dbConfig = resourceConfig.currentConfig || {};
          document.getElementById('current-node').textContent = resources.node || dbConfig.current_node || '-';
          document.getElementById('current-memory').textContent =
            (resources.memory_gb || dbConfig.memory_gb)
              ? (resources.memory_gb || dbConfig.memory_gb) + ' GB'
              : '-';
          document.getElementById('current-cpus').textContent = resources.cpu || dbConfig.cpus || '-';
          document.getElementById('current-storage').textContent =
            (resources.storage_gb || dbConfig.storage_gb)
              ? (resources.storage_gb || dbConfig.storage_gb) + ' GB'
              : '-';
          selectedNode = (resources.node || dbConfig.current_node || 'hydra').toLowerCase();

          // Update node cards with live metrics from nodes object
          if (resourceConfig.nodes) {
            updateNodeCards(resourceConfig.nodes);
          }

          // Show recommendation if available
          if (resourceConfig.recommendation) {
            currentRecommendation = resourceConfig.recommendation;
            showRecommendation(currentRecommendation);
          }

          // Highlight currently selected node
          selectNode(selectedNode, false);

          msg.innerHTML = '';
          updateApprovalStatus();
        } catch (err) {
          console.error('[Resource Modal] Failed to load configuration:', err);
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2"><i class="fas fa-exclamation-circle"></i> ${err.message || 'Failed to load configuration'}</p>`;
        }
      };

      // Update node cards with live metrics from API
      function updateNodeCards(nodes) {
        // Hydra
        if (nodes.hydra) {
          const h = nodes.hydra;
          const capacity = h.capacity || {};
          const usedSlots = h.maxContainers - (capacity.availableSlots || 0);
          const usedPercent = h.maxContainers > 0 ? Math.round((usedSlots / h.maxContainers) * 100) : 0;
          document.getElementById('hydra-capacity-bar').style.width = usedPercent + '%';
          document.getElementById('hydra-capacity-bar').className = 'h-full transition-all ' + getCapacityColor(usedPercent);
          document.getElementById('hydra-slots').textContent = capacity.availableSlots || 0;
          document.getElementById('hydra-status-dot').className = 'w-2 h-2 rounded-full ' + (h.online && !h.maintenance ? 'bg-green-500' : 'bg-red-500');
        }

        // Chimera
        if (nodes.chimera) {
          const c = nodes.chimera;
          const capacity = c.capacity || {};
          const usedSlots = c.maxContainers - (capacity.availableSlots || 0);
          const usedPercent = c.maxContainers > 0 ? Math.round((usedSlots / c.maxContainers) * 100) : 0;
          document.getElementById('chimera-capacity-bar').style.width = usedPercent + '%';
          document.getElementById('chimera-capacity-bar').className = 'h-full transition-all ' + getCapacityColor(usedPercent);
          document.getElementById('chimera-slots').textContent = capacity.availableSlots || 0;
          document.getElementById('chimera-gpu-util').textContent = c.gpu ? (c.gpu.utilization || 0) : 0;
          document.getElementById('chimera-status-dot').className = 'w-2 h-2 rounded-full ' + (c.online && !c.maintenance ? 'bg-green-500' : 'bg-red-500');
        }

        // Cerberus
        if (nodes.cerberus) {
          const cb = nodes.cerberus;
          const capacity = cb.capacity || {};
          const usedSlots = cb.maxContainers - (capacity.availableSlots || 0);
          const usedPercent = cb.maxContainers > 0 ? Math.round((usedSlots / cb.maxContainers) * 100) : 0;
          document.getElementById('cerberus-capacity-bar').style.width = usedPercent + '%';
          document.getElementById('cerberus-capacity-bar').className = 'h-full transition-all ' + getCapacityColor(usedPercent);
          document.getElementById('cerberus-slots').textContent = capacity.availableSlots || 0;
          document.getElementById('cerberus-gpu-util').textContent = cb.gpu ? (cb.gpu.utilization || 0) : 0;
          document.getElementById('cerberus-status-dot').className = 'w-2 h-2 rounded-full ' + (cb.online ? (cb.maintenance ? 'bg-yellow-500' : 'bg-green-500') : 'bg-red-500');
        }
      }

      function getCapacityColor(percent) {
        if (percent >= 80) return 'bg-red-500';
        if (percent >= 60) return 'bg-yellow-500';
        return 'bg-green-500';
      }

      // Show recommendation banner
      function showRecommendation(rec) {
        if (!rec || !rec.recommended) {
          document.getElementById('recommendation-banner').classList.add('hidden');
          return;
        }

        document.getElementById('rec-node-name').textContent = rec.recommended.charAt(0).toUpperCase() + rec.recommended.slice(1);
        document.getElementById('rec-reason').textContent = rec.reason || 'Best fit for your workload';
        document.getElementById('recommendation-banner').classList.remove('hidden');
      }

      // Handle node card selection
      window.selectNode = function(nodeName, updateRec = true) {
        selectedNode = nodeName.toLowerCase();
        document.getElementById('target-node').value = selectedNode;

        // Update visual selection on cards
        ['hydra', 'chimera', 'cerberus'].forEach(n => {
          const card = document.getElementById('node-card-' + n);
          if (n === selectedNode) {
            card.classList.add('border-purple-500', 'border-2', 'bg-purple-50');
          } else {
            card.classList.remove('border-purple-500', 'border-2', 'bg-purple-50');
          }
        });

        // Update selected node display
        const labels = {
          hydra: 'Hydra (Control Plane)',
          chimera: 'Chimera (GPU Inference)',
          cerberus: 'Cerberus (GPU Training)'
        };
        document.getElementById('selected-node-label').textContent = labels[selectedNode] || selectedNode;

        // Show GPU info for GPU nodes
        const gpuInfo = document.getElementById('selected-node-gpu-info');
        if (selectedNode === 'chimera' || selectedNode === 'cerberus') {
          gpuInfo.classList.remove('hidden');
          if (resourceConfig && resourceConfig.nodes && resourceConfig.nodes[selectedNode]) {
            const node = resourceConfig.nodes[selectedNode];
            const availGpus = node.gpu ? (node.gpu.available || 0) : 0;
            document.getElementById('selected-gpu-avail').textContent = availGpus;
            document.getElementById('selected-gpu-model').textContent = node.gpuModel || (selectedNode === 'chimera' ? 'RTX 3090' : 'RTX 5090');
          }
        } else {
          gpuInfo.classList.add('hidden');
        }

        // Update approval status and get new recommendation
        updateApprovalStatus();
        if (updateRec) {
          updateRecommendation();
        }
      };

      // Apply the auto-recommendation
      window.applyRecommendation = function() {
        if (currentRecommendation && currentRecommendation.recommended) {
          selectNode(currentRecommendation.recommended, false);
        }
      };

      // Get updated recommendation based on current selections
      async function updateRecommendation() {
        const preset = document.getElementById('resource-preset').value;
        const storage = parseInt(document.getElementById('storage-tier').value);

        try {
          const res = await fetch('/dashboard/api/resource-requests/recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ preset_id: preset, storage_gb: storage })
          });

          if (res.ok) {
            const data = await res.json();
            // API returns { recommendation: {...}, nodeMetrics: {...} }
            currentRecommendation = data.recommendation || data;
            showRecommendation(currentRecommendation);

            // Update node metrics if provided
            if (data.nodeMetrics) {
              if (!resourceConfig.nodes) resourceConfig.nodes = {};
              Object.assign(resourceConfig.nodes, data.nodeMetrics);
              updateNodeCards(resourceConfig.nodes);
            }

            // Update wait time info
            const wait = currentRecommendation.estimatedWait || currentRecommendation.estimated_wait;
            if (wait) {
              document.getElementById('queue-info').classList.remove('hidden');
              document.getElementById('estimated-wait').textContent = wait;
            } else {
              document.getElementById('queue-info').classList.add('hidden');
            }

            // Show capacity warning if node is busy
            const capacityWarning = document.getElementById('preset-capacity-warning');
            if (currentRecommendation.alternatives && currentRecommendation.alternatives.length > 0) {
              capacityWarning.classList.remove('hidden');
            } else {
              capacityWarning.classList.add('hidden');
            }
          }
        } catch (err) {
          console.error('Failed to get recommendation:', err);
        }
      }

      window.hideResourceModal = function () {
        document.getElementById('resource-modal').classList.add('hidden');
      };

      function updateApprovalStatus() {
        const targetNode = document.getElementById('target-node').value;
        const preset = document.getElementById('resource-preset').value;
        const storage = parseInt(document.getElementById('storage-tier').value);
        const durationDays = parseInt(document.getElementById('duration-days').value);

        // Check if this requires approval
        // GPU nodes require approval, but returning to hydra is auto-approved
        const needsApproval = (
          targetNode !== 'hydra' ||
          preset !== 'conservative' ||
          storage > 50 ||
          durationDays > 30
        );

        const approvalWarning = document.getElementById('approval-warning');
        const autoApproveInfo = document.getElementById('auto-approve-info');
        const reasonSection = document.getElementById('reason-section');

        if (needsApproval) {
          approvalWarning.classList.remove('hidden');
          autoApproveInfo.classList.add('hidden');
          reasonSection.classList.remove('hidden');
        } else {
          approvalWarning.classList.add('hidden');
          autoApproveInfo.classList.remove('hidden');
          reasonSection.classList.add('hidden');
        }

        // Update button text
        const submitBtn = document.getElementById('submit-resource-btn');
        submitBtn.innerHTML = needsApproval
          ? '<i class="fas fa-paper-plane"></i> Submit Request'
          : '<i class="fas fa-check"></i> Apply Configuration';
      }

      // Add change listeners
      document.getElementById('target-node').addEventListener('change', updateApprovalStatus);
      document.getElementById('resource-preset').addEventListener('change', function() {
        updateApprovalStatus();
        updateRecommendation();
      });
      document.getElementById('storage-tier').addEventListener('change', function() {
        updateApprovalStatus();
        updateRecommendation();
      });
      document.getElementById('duration-days').addEventListener('change', updateApprovalStatus);

      // Handle form submission
      document.getElementById('resource-config-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const msg = document.getElementById('resource-modal-message');
        msg.innerHTML = '<p class="text-gray-600">Submitting request...</p>';

        try {
          const res = await fetch('/dashboard/api/resource-requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              target_node: document.getElementById('target-node').value,
              preset_id: document.getElementById('resource-preset').value,
              storage_gb: parseInt(document.getElementById('storage-tier').value),
              duration_days: parseInt(document.getElementById('duration-days').value),
              reason: document.getElementById('request-reason').value || null
            })
          });

          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Failed to submit request');
          }

          if (data.auto_approved) {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Configuration applied! Restart your container to use the new settings.</p>';
          } else {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Request submitted! You will receive an email when it is reviewed.</p>';
          }

          setTimeout(() => {
            hideResourceModal();
            loadPendingRequests();
          }, 2000);
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to submit request'}</p>`;
        }
      });

      async function loadPendingRequests() {
        try {
          const res = await fetch('/dashboard/api/resource-requests/my');
          if (handleAuthError(res)) return;
          const data = await res.json();

          const section = document.getElementById('pending-request-section');
          if (data.hasPendingRequest && data.pending.length > 0) {
            const request = data.pending[0];
            pendingRequestId = request.id;

            document.getElementById('pending-target-node').textContent = request.target_node.charAt(0).toUpperCase() + request.target_node.slice(1);
            document.getElementById('pending-resources').textContent = `${request.requested_memory_gb}GB RAM, ${request.requested_cpus} CPUs, ${request.requested_storage_gb}GB storage`;
            document.getElementById('pending-duration').textContent = request.requested_duration_days ? `${request.requested_duration_days} days` : 'N/A';
            document.getElementById('pending-submitted').textContent = new Date(request.created_at).toLocaleString();

            section.classList.remove('hidden');
          } else {
            section.classList.add('hidden');
            pendingRequestId = null;
          }
        } catch (err) {
          console.error('Failed to load pending requests:', err);
        }
      }

      window.cancelPendingRequest = async function () {
        if (!pendingRequestId) return;
        if (!confirm('Cancel this resource request?')) return;

        try {
          const res = await fetch(`/dashboard/api/resource-requests/${pendingRequestId}`, {
            method: 'DELETE'
          });

          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!res.ok) throw new Error(data.error || 'Failed to cancel');

          const msg = document.getElementById('container-message');
          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Request cancelled.</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          loadPendingRequests();
        } catch (err) {
          const msg = document.getElementById('container-message');
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${err.message || 'Failed to cancel request'}</p>`;
        }
      };

      // Load pending requests on page load
      loadPendingRequests();

      async function loadServices() {
        try {
          const res = await fetch('/dashboard/api/containers/services');
          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!data.success || !data.containerRunning) return;

          const services = data.services || [];
          const vscode = services.find(s => s.name === 'code-server');
          const jupyter = services.find(s => s.name === 'jupyter');

          // Update VS Code status
          if (vscode) {
            document.getElementById('vscode-service-status').textContent = vscode.running ? '● Running' : '○ Stopped';
            document.getElementById('vscode-service-status').className = vscode.running ? 'text-sm text-green-600' : 'text-sm text-gray-500';
          }

          // Update Jupyter status
          if (jupyter) {
            document.getElementById('jupyter-service-status').textContent = jupyter.running ? '● Running' : '○ Stopped';
            document.getElementById('jupyter-service-status').className = jupyter.running ? 'text-sm text-green-600' : 'text-sm text-gray-500';
          }
        } catch (err) {
          console.error('Failed to load services:', err);
        }
      }

      window.startService = async function (serviceName) {
        try {
          const res = await fetch(`/dashboard/api/containers/services/${serviceName}/start`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          setTimeout(loadServices, 1000);
        } catch (err) {
          alert('Failed to start service: ' + err.message);
        }
      };

      window.stopService = async function (serviceName) {
        try {
          const res = await fetch(`/dashboard/api/containers/services/${serviceName}/stop`, { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          setTimeout(loadServices, 1000);
        } catch (err) {
          alert('Failed to stop service: ' + err.message);
        }
      };

      window.openServiceURL = function (endpoint) {
        const username = "<%= user.email %>".split('@')[0];
        const url = `<%= baseUrl %>/students/${username}/${endpoint}/`;
        window.open(url, '_blank');
      };

      async function loadRoutes() {
        try {
          const res = await fetch('/dashboard/api/containers/routes');
          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!data.success) return;

          const tbody = document.getElementById('routes-tbody');
          tbody.innerHTML = '';

          const routes = data.routes || [];
          routes.forEach(route => {
            const row = document.createElement('tr');
            const isDefault = route.endpoint === 'vscode' || route.endpoint === 'jupyter';
            const routeType = route.source || (isDefault ? 'default' : 'custom');

            // Determine badge style based on route type
            let typeBadge = '';
            if (routeType === 'default') {
              typeBadge = '<span class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600 border border-gray-200">Default</span>';
            } else if (routeType === 'auto-discovered') {
              typeBadge = '<span class="px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-700 border border-indigo-200">Auto-discovered</span>';
            } else {
              typeBadge = '<span class="px-2 py-0.5 text-xs rounded bg-green-100 text-green-700 border border-green-200">Custom</span>';
            }

            row.innerHTML = `
              <td class="px-3 py-2 font-mono">${route.endpoint}</td>
              <td class="px-3 py-2">${route.port}</td>
              <td class="px-3 py-2">${typeBadge}</td>
              <td class="px-3 py-2">
                <a href="${route.url}" target="_blank" class="text-blue-600 underline text-xs">
                  <i class="fas fa-external-link-alt"></i> ${route.url}
                </a>
              </td>
              <td class="px-3 py-2">
                ${isDefault
                  ? '<span class="text-xs text-gray-400">-</span>'
                  : `<button onclick="deleteRoute('${route.endpoint}')" class="px-2 py-1 text-xs rounded bg-red-100 hover:bg-red-200 text-red-700">
                      <i class="fas fa-trash"></i> Delete
                    </button>`
                }
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error('Failed to load routes:', err);
        }
      }

      // Load server status (CPU, RAM, Disk for all servers)
      async function loadServerStatus() {
        try {
          const statusRes = await fetch('/api/servers/status');
          if (!statusRes.ok) throw new Error('Failed to fetch server status');
          const statusData = await statusRes.json();

          if (statusData.servers) {
            // Helper to update server card
            const updateServer = (name, data) => {
              if (!data) return;
              const badge = document.getElementById(`${name}-status-badge`);
              if (badge) {
                badge.textContent = data.status === 'online' ? 'Online' : (data.status || 'Unknown');
                badge.className = data.status === 'online'
                  ? 'px-2 py-1 text-xs rounded bg-green-100 text-green-700'
                  : 'px-2 py-1 text-xs rounded bg-gray-100 text-gray-600';
              }
              const cpu = document.getElementById(`${name}-cpu`);
              if (cpu) cpu.textContent = `${data.cpu_percent || 0}%`;
              const ram = document.getElementById(`${name}-ram`);
              if (ram) ram.textContent = `${data.ram_used_gb || 0}/${data.ram_total_gb || 0} GB`;
              const disk = document.getElementById(`${name}-disk`);
              if (disk && data.disk_total_gb) {
                disk.textContent = `${Math.round((data.disk_used_gb || 0) / 1000)}/${Math.round(data.disk_total_gb / 1000)} TB`;
              } else if (disk) {
                disk.textContent = '--';
              }
            };

            updateServer('hydra', statusData.servers.hydra);
            updateServer('chimera', statusData.servers.chimera);
            updateServer('cerberus', statusData.servers.cerberus);
          }
        } catch (err) {
          console.error('Failed to load server status:', err);
        }
      }

      window.addRoute = async function () {
        const endpoint = document.getElementById('new-endpoint').value.trim().toLowerCase();
        const port = Number(document.getElementById('new-port').value);
        const msg = document.getElementById('routing-message');

        if (!endpoint || !/^[a-z0-9-]{1,40}$/.test(endpoint)) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Invalid endpoint name (alphanumeric and hyphens only)</p>';
          return;
        }

        if (!port || port < 1024 || port > 65535) {
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Port must be between 1024-65535</p>';
          return;
        }

        try {
          msg.innerHTML = '<p class="text-gray-600 text-sm">Adding route...</p>';
          const res = await fetch('/dashboard/api/containers/routes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint, port })
          });
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm">Route added successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          document.getElementById('new-endpoint').value = '';
          document.getElementById('new-port').value = '';

          loadRoutes();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to add route'}</p>`;
        }
      };

      window.deleteRoute = async function (endpoint) {
        if (!confirm(`Delete route "${endpoint}"?`)) return;

        const msg = document.getElementById('routing-message');
        try {
          const res = await fetch(`/dashboard/api/containers/routes/${encodeURIComponent(endpoint)}`, { method: 'DELETE' });
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm">Route deleted!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          loadRoutes();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to delete route'}</p>`;
        }
      };

      // Store discovered services for reference when adding
      let discoveredServicesData = [];

      window.discoverServices = async function () {
        const discoverBtn = document.getElementById('discover-btn');
        const discoverIcon = document.getElementById('discover-icon');
        const msg = document.getElementById('discover-message');
        const servicesContainer = document.getElementById('discovered-services');
        const tbody = document.getElementById('discovered-tbody');
        const noServicesMsg = document.getElementById('no-services-found');

        // Show loading state
        discoverBtn.disabled = true;
        discoverIcon.className = 'fas fa-spinner fa-spin';
        msg.innerHTML = '<p class="text-gray-600 text-sm">Scanning supervisor.d configs...</p>';

        try {
          const res = await fetch('/dashboard/api/containers/discover-services', { method: 'POST' });
          if (handleAuthError(res)) return;
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed to discover services');

          // Reset button state
          discoverBtn.disabled = false;
          discoverIcon.className = 'fas fa-radar';
          msg.innerHTML = '';

          // Store discovered services
          discoveredServicesData = data.services || [];

          // Show the discovered services section
          servicesContainer.classList.remove('hidden');
          tbody.innerHTML = '';

          if (discoveredServicesData.length === 0) {
            noServicesMsg.classList.remove('hidden');
            return;
          }

          noServicesMsg.classList.add('hidden');

          discoveredServicesData.forEach((service, index) => {
            const row = document.createElement('tr');
            const isRouted = service.alreadyRouted;

            row.innerHTML = `
              <td class="px-3 py-2 font-mono">${escapeHtml(service.name)}</td>
              <td class="px-3 py-2">${service.port}</td>
              <td class="px-3 py-2 font-mono">${escapeHtml(service.endpoint)}</td>
              <td class="px-3 py-2">
                ${isRouted
                  ? '<span class="text-green-600"><i class="fas fa-check-circle"></i> Already routed</span>'
                  : '<span class="text-gray-500">Not routed</span>'
                }
              </td>
              <td class="px-3 py-2">
                ${isRouted
                  ? '<span class="text-green-600"><i class="fas fa-check"></i></span>'
                  : `<button onclick="addDiscoveredRoute(${index})" class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700">
                      <i class="fas fa-plus"></i> Add
                    </button>`
                }
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (err) {
          discoverBtn.disabled = false;
          discoverIcon.className = 'fas fa-radar';
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to discover services'}</p>`;
        }
      };

      window.addDiscoveredRoute = async function (index) {
        const service = discoveredServicesData[index];
        if (!service) return;

        const msg = document.getElementById('discover-message');
        try {
          msg.innerHTML = '<p class="text-gray-600 text-sm">Adding route...</p>';
          const res = await fetch('/dashboard/api/containers/routes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              endpoint: service.endpoint,
              port: service.port,
              source: 'auto-discovered'
            })
          });
          const data = await res.json();

          if (!res.ok || !data.success) throw new Error(data.message || 'Failed');

          msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm">Route added successfully!</p>';
          setTimeout(() => { msg.innerHTML = ''; }, 3000);

          // Refresh both the routes table and discovered services
          loadRoutes();
          discoverServices();
        } catch (err) {
          msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">${err.message || 'Failed to add route'}</p>`;
        }
      };

      // Helper function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      window.openLogs = function () {
        const w = window.open('', '_blank', 'width=900,height=600');
        w.document.write('<!DOCTYPE html><html><head><title>Container Logs</title>');
        w.document.write('<style>body { margin: 0; padding: 0; background: #1a1a1a; font-family: monospace; }');
        w.document.write('#log { white-space: pre-wrap; margin: 0; padding: 12px; color: #ddd; height: 100vh; overflow: auto; font-size: 12px; line-height: 1.4; }</style></head>');
        w.document.write('<body><pre id="log"></pre>');
        w.document.write('<sc' + 'ript>');
        w.document.write('const es = new EventSource("/dashboard/api/containers/logs/stream");');
        w.document.write('const pre = document.getElementById("log");');
        w.document.write('es.onmessage = (e) => { pre.textContent += e.data + "\\n"; pre.scrollTop = pre.scrollHeight; };');
        w.document.write('es.onerror = () => { pre.textContent += "\\n[Stream closed]\\n"; es.close(); };');
        w.document.write('window.addEventListener("beforeunload", () => es.close());');
        w.document.write('</sc' + 'ript></body></html>');
      };

      window.openTerminal = function () {
        const username = "<%= user.email %>".split('@')[0];
        const containerName = `student-${username}`;

        const w = window.open('', '_blank', 'width=1000,height=700');
        const doc = w.document;

        doc.open();
        doc.write('<!DOCTYPE html><html><head><title>Terminal: ' + containerName + '</title></head><body></body></html>');
        doc.close();

        // Add stylesheet
        const link = doc.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css';
        doc.head.appendChild(link);

        // Add styles
        const style = doc.createElement('style');
        style.textContent = 'body { margin: 0; padding: 0; background: #000; } #terminal { height: 100vh; padding: 8px; }';
        doc.head.appendChild(style);

        // Add terminal div
        const terminalDiv = doc.createElement('div');
        terminalDiv.id = 'terminal';
        doc.body.appendChild(terminalDiv);

        // Load xterm.js and initialize
        const script = doc.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js';
        script.onload = function () {
          const term = new w.Terminal({
            convertEol: true,
            fontFamily: "monospace",
            fontSize: 14,
            cursorBlink: true,
            theme: { background: "#000000", foreground: "#ffffff" }
          });
          term.open(doc.getElementById("terminal"));
          term.writeln("Connecting to container...");

          const proto = location.protocol === "https:" ? "wss" : "ws";
          const ws = new WebSocket(proto + "://" + location.host + "/dashboard/ws/containers/" + encodeURIComponent(containerName) + "/exec");
          ws.binaryType = "arraybuffer";
          ws.onopen = function () { term.clear(); term.writeln("Connected! Type commands below:"); term.write("$ "); };
          ws.onmessage = function (ev) { term.write(new Uint8Array(ev.data)); };
          ws.onclose = function () { term.writeln("\r\n[Connection closed]"); };
          ws.onerror = function () { term.writeln("\r\n[Connection error]"); };
          term.onData(function (data) { if (ws.readyState === WebSocket.OPEN) ws.send(data); });
        };
        doc.head.appendChild(script);
      };
    });

    // Function to check if user exists in OpenWebUI
    function checkUserExists(email, name) {
      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/check-user', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('webui-status-loading').classList.add('hidden');

          if (data.exists) {
            // Show account exists section
            document.getElementById('webui-account-exists').classList.remove('hidden');
            document.getElementById('webui-username').textContent = data.username;
            document.getElementById('webui-role').textContent = data.role;
          } else {
            // Show create account section
            document.getElementById('webui-create-account').classList.remove('hidden');
          }
        })
        .catch(error => {
          console.error('Error checking user:', error);
          document.getElementById('webui-status-loading').innerHTML =
            '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error checking account status. Please try again later.</p>';
        });
    }

    // n8n helpers
    function checkN8nStatus() {
      fetch('/dashboard/api/n8n/status', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          document.getElementById('n8n-status-loading').classList.add('hidden');
          if (data.exists === false) {
            // User doesn't exist - show create account section
            document.getElementById('n8n-create-account').classList.remove('hidden');
          } else if (data.id && data.isPending) {
            // User exists but is pending - show they need to complete setup
            document.getElementById('n8n-create-account').classList.remove('hidden');
            const msg = document.getElementById('n8n-create-message');
            msg.innerHTML = '<p class="text-yellow-700 bg-yellow-100 border border-yellow-200 rounded p-2">You have a pending invite. Click "Request n8n Invite" to resend the invitation link.</p>';
          } else if (data.id) {
            // User exists and is active - show account exists section
            document.getElementById('n8n-account-exists').classList.remove('hidden');
            if (data.role) document.getElementById('n8n-role').textContent = data.role;
          } else {
            // Unexpected response
            document.getElementById('n8n-status-loading').innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Unexpected response from n8n.</p>';
          }
        })
        .catch(err => {
          console.error('Error checking n8n status:', err);
          document.getElementById('n8n-status-loading').innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error checking n8n status.</p>';
        });
    }

    function createN8nAccount() {
      // Email is taken from server-side auth; body is not required
      const msg = document.getElementById('n8n-create-message');
      fetch('/dashboard/api/n8n/create-user', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          // If array [] -> already has account, no invite
          if (data.length == 0) {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Account already active. No invite needed.</p>';
            return;
          }
          data = data[0]; // Get first item
          if (data && data.user && data.user.inviteAcceptUrl) {
            const link = data.user.inviteAcceptUrl;
            document.getElementById('n8n-invite-link').textContent = link;
            document.getElementById('n8n-invite-link').href = link;
            document.getElementById('n8n-invite').classList.remove('hidden');
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Invite created successfully.</p>';
          } else if (data && data.error) {
            msg.innerHTML = `<p class=\"text-red-700 bg-red-100 border border-red-200 rounded p-2\">${data.error}</p>`;
          } else {
            msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Unexpected response.</p>';
          }
        })
        .catch(err => {
          console.error('Error creating n8n account:', err);
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Failed to create n8n account.</p>';
        });
    }

    function changeN8nPassword() {
      const newPassword = document.getElementById('n8n-new-password').value;
      const confirmPassword = document.getElementById('n8n-confirm-password').value;
      const msg = document.getElementById('n8n-change-password-message');

      // Check if passwords match
      if (newPassword !== confirmPassword) {
        msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Passwords do not match.</p>';
        return;
      }

      // Check password length
      if (newPassword.length < 8) {
        msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Password must be at least 8 characters.</p>';
        return;
      }

      msg.innerHTML = '<p class="text-gray-600">Changing password...</p>';

      fetch('/dashboard/api/n8n/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ newPassword })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            msg.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Password changed successfully!</p>';
            document.getElementById('n8n-change-password-form').reset();
          } else {
            msg.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">${data.message || 'Failed to change password'}</p>`;
          }
        })
        .catch(err => {
          console.error('Error changing n8n password:', err);
          msg.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error changing password. Please try again.</p>';
        });
    }

    // Function to create an account
    function createAccount(email, name) {
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const messageDiv = document.getElementById('create-account-message');

      // Check if passwords match
      if (password !== confirmPassword) {
        messageDiv.innerHTML = '<p class="message error">Passwords do not match.</p>';
        return;
      }

      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/create-account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          name: name,
          password: password
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            messageDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Account created successfully!</p>';
            // Refresh account status after a short delay
            setTimeout(() => {
              checkUserExists(email, name);
            }, 2000);
          } else {
            messageDiv.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('Error creating account:', error);
          messageDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error creating account. Please try again later.</p>';
        });
    }

    // Function to change password
    function changePassword(email) {
      const newPassword = document.getElementById('new-password-change').value;
      const confirmPassword = document.getElementById('confirm-password-change').value;
      const messageDiv = document.getElementById('change-password-message');

      // Check if passwords match
      if (newPassword !== confirmPassword) {
        messageDiv.innerHTML = '<p class="message error">Passwords do not match.</p>';
        return;
      }

      // This would be an AJAX call to your backend
      fetch('/dashboard/api/webui/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          password: newPassword
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            messageDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2">Password updated successfully!</p>';
            // Clear the form
            document.getElementById('change-password-form').reset();
          } else {
            messageDiv.innerHTML = `<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('Error changing password:', error);
          messageDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2">Error updating password. Please try again later.</p>';
        });
    }

    // ==================== Admin Approval Panel ====================
    <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
    // Fetch and display pending requests
    async function loadAdminRequests() {
      try {
        const res = await fetch('/dashboard/api/admin/requests');
        const data = await res.json();
        const badge = document.getElementById('admin-badge');
        const list = document.getElementById('admin-requests-list');

        const count = data.requests ? data.requests.length : 0;
        badge.textContent = count;
        badge.classList.toggle('hidden', count === 0);

        if (count === 0) {
          list.innerHTML = '<p class="p-4 text-gray-500 text-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>No pending requests</p>';
          return;
        }

        list.innerHTML = data.requests.map(r => {
          // Special display for Jupyter execution requests
          const isJupyter = r.request_type === 'jupyter_execution';
          const typeLabel = isJupyter ? 'Jupyter/GPU Access' : (r.preset_id || 'custom');
          const typeBgColor = isJupyter ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800';
          const reasonText = r.reason ? `<p class="text-xs text-gray-500 mt-1 italic">"${escapeHtml(r.reason)}"</p>` : '';

          return `
          <div class="p-3 border-b hover:bg-gray-50 transition-colors">
            <div class="flex justify-between items-start gap-2">
              <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-900 truncate">${escapeHtml(r.email)}</p>
                <p class="text-sm text-gray-600">
                  <span class="inline-block ${typeBgColor} text-xs px-2 py-0.5 rounded">${escapeHtml(typeLabel)}</span>
                  ${isJupyter ? '' : `<i class="fas fa-arrow-right mx-1 text-gray-400"></i>
                  <span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-0.5 rounded">${escapeHtml(r.target_node)}</span>`}
                </p>
                ${isJupyter ? reasonText : `<p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-memory mr-1"></i>${r.requested_memory_gb}GB
                  <i class="fas fa-microchip ml-2 mr-1"></i>${r.requested_cpus} CPU
                  <i class="fas fa-hdd ml-2 mr-1"></i>${r.requested_storage_gb}GB
                </p>`}
              </div>
              <div class="flex gap-1 shrink-0">
                <button onclick="approveRequest(${r.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm transition-colors" title="Approve">
                  <i class="fas fa-check"></i>
                </button>
                <button onclick="denyRequest(${r.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition-colors" title="Deny">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        `}).join('');
      } catch (err) {
        console.error('Error loading admin requests:', err);
        document.getElementById('admin-requests-list').innerHTML =
          '<p class="p-4 text-red-500 text-center"><i class="fas fa-exclamation-circle mr-2"></i>Error loading requests</p>';
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function approveRequest(id) {
      try {
        const res = await fetch(`/dashboard/api/admin/requests/${id}/approve`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadAdminRequests();
        } else {
          alert('Error approving request: ' + (data.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error approving request:', err);
        alert('Error approving request');
      }
    }

    async function denyRequest(id) {
      const reason = prompt('Reason for denial (optional):');
      try {
        const res = await fetch(`/dashboard/api/admin/requests/${id}/deny`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin_notes: reason || '' })
        });
        const data = await res.json();
        if (data.success) {
          loadAdminRequests();
        } else {
          alert('Error denying request: ' + (data.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error denying request:', err);
        alert('Error denying request');
      }
    }

    async function approveAllRequests() {
      if (!confirm('Approve all pending requests?')) return;
      try {
        const res = await fetch('/dashboard/api/admin/requests');
        const data = await res.json();
        for (const r of (data.requests || [])) {
          await fetch(`/dashboard/api/admin/requests/${r.id}/approve`, { method: 'POST' });
        }
        loadAdminRequests();
      } catch (err) {
        console.error('Error approving all requests:', err);
        alert('Error approving requests');
      }
    }

    // Toggle admin dropdown
    document.getElementById('admin-toggle').addEventListener('click', () => {
      document.getElementById('admin-dropdown').classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('admin-panel');
      if (!panel.contains(e.target)) {
        document.getElementById('admin-dropdown').classList.add('hidden');
      }
    });

    document.getElementById('approve-all-btn').addEventListener('click', approveAllRequests);
    document.getElementById('refresh-requests-btn').addEventListener('click', loadAdminRequests);

    // Load on page load and poll every 30s
    loadAdminRequests();
    setInterval(loadAdminRequests, 30000);

    // ========== Whitelist Management ==========
    window.openWhitelistModal = function() {
      document.getElementById('whitelist-modal').classList.remove('hidden');
      loadWhitelist();
      loadWhitelistAutocomplete();
    };

    window.closeWhitelistModal = function() {
      document.getElementById('whitelist-modal').classList.add('hidden');
    };

    async function loadWhitelist() {
      try {
        const res = await fetch('/dashboard/api/admin/whitelist');
        const data = await res.json();
        const tbody = document.getElementById('whitelist-body');

        if (!data.whitelist || data.whitelist.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">No users in whitelist</td></tr>';
          return;
        }

        tbody.innerHTML = data.whitelist.map(u => `
          <tr class="border-t hover:bg-gray-50">
            <td class="px-3 py-2">${u.email}</td>
            <td class="px-3 py-2">
              <span class="px-2 py-0.5 rounded text-xs ${
                u.role === 'admin' ? 'bg-purple-100 text-purple-700' :
                u.role === 'faculty' ? 'bg-blue-100 text-blue-700' :
                'bg-green-100 text-green-700'
              }">${u.role}</span>
            </td>
            <td class="px-3 py-2">
              <span class="text-xs ${u.source === 'env' ? 'text-orange-600' : 'text-gray-500'}">${u.source}</span>
            </td>
            <td class="px-3 py-2 text-right">
              ${u.source === 'database' ? `
                <button onclick="removeFromWhitelist('${u.email}')" class="text-red-600 hover:text-red-800 text-sm" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              ` : '<span class="text-xs text-gray-400">env var</span>'}
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading whitelist:', err);
        document.getElementById('whitelist-body').innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-red-500">Error loading whitelist</td></tr>';
      }
    }

    let whitelistUserData = [];
    let whitelistSelected = new Set();

    async function loadWhitelistAutocomplete() {
      try {
        const res = await fetch('/dashboard/api/admin/whitelist/autocomplete');
        const data = await res.json();
        const datalist = document.getElementById('whitelist-suggestions');
        whitelistUserData = data.suggestions || [];
        datalist.innerHTML = whitelistUserData.map(u => `<option value="${u.email}">${u.username}</option>`).join('');
        renderWhitelistChips();
      } catch (err) {
        console.error('Error loading autocomplete:', err);
      }
    }

    function renderWhitelistChips() {
      const container = document.getElementById('whitelist-user-chips');
      if (!whitelistUserData.length) {
        container.innerHTML = '<span class="text-xs text-gray-400">No existing users found</span>';
        return;
      }
      container.innerHTML = whitelistUserData.map(u => {
        const isOnline = u.status === 'running' || u.online;
        const isSelected = whitelistSelected.has(u.email);
        return `<button onclick="toggleWhitelistChip('${u.email}')"
          class="px-2 py-1 rounded-full text-xs border transition-all ${
            isSelected
              ? 'bg-purple-600 text-white border-purple-600'
              : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'
          }" data-email="${u.email}" data-online="${isOnline}">
          <i class="fas fa-circle text-[8px] mr-1 ${isOnline ? 'text-green-400' : 'text-gray-300'}"></i>${u.username}
        </button>`;
      }).join('');
      updateSelectedCount();
    }

    window.toggleWhitelistChip = function(email) {
      if (whitelistSelected.has(email)) {
        whitelistSelected.delete(email);
      } else {
        whitelistSelected.add(email);
      }
      renderWhitelistChips();
    };

    window.selectAllWhitelistUsers = function(filter) {
      whitelistSelected.clear();
      whitelistUserData.forEach(u => {
        if (filter === 'all' || (filter === 'online' && (u.status === 'running' || u.online))) {
          whitelistSelected.add(u.email);
        }
      });
      renderWhitelistChips();
    };

    function updateSelectedCount() {
      const count = whitelistSelected.size;
      const btn = document.getElementById('whitelist-add-selected-btn');
      const countEl = document.getElementById('whitelist-selected-count');
      countEl.textContent = count;
      btn.classList.toggle('hidden', count === 0);
    }

    window.addSelectedToWhitelist = async function() {
      const role = document.getElementById('whitelist-role').value;
      const reason = document.getElementById('whitelist-reason').value.trim() || 'Bulk added';
      const msgEl = document.getElementById('whitelist-add-message');
      const emails = Array.from(whitelistSelected);

      if (!emails.length) return;

      let added = 0, failed = 0;
      msgEl.innerHTML = `<p class="text-blue-600 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i>Adding ${emails.length} users...</p>`;

      for (const email of emails) {
        try {
          const res = await fetch('/dashboard/api/admin/whitelist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, role, reason })
          });
          if (res.ok) added++; else failed++;
        } catch { failed++; }
      }

      whitelistSelected.clear();
      renderWhitelistChips();
      loadWhitelist();
      msgEl.innerHTML = `<p class="text-green-600 text-sm"><i class="fas fa-check mr-1"></i>${added} added${failed ? `, ${failed} failed` : ''}</p>`;
      setTimeout(() => { msgEl.innerHTML = ''; }, 4000);
    };

    window.addToWhitelist = async function() {
      const email = document.getElementById('whitelist-email').value.trim();
      const role = document.getElementById('whitelist-role').value;
      const reason = document.getElementById('whitelist-reason').value.trim();
      const msgEl = document.getElementById('whitelist-add-message');

      if (!email) {
        msgEl.innerHTML = '<p class="text-red-600 text-sm">Email is required</p>';
        return;
      }

      try {
        const res = await fetch('/dashboard/api/admin/whitelist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role, reason })
        });
        const data = await res.json();

        if (res.ok && data.success) {
          msgEl.innerHTML = '<p class="text-green-600 text-sm"><i class="fas fa-check mr-1"></i>Added successfully</p>';
          document.getElementById('whitelist-email').value = '';
          document.getElementById('whitelist-reason').value = '';
          loadWhitelist();
          setTimeout(() => { msgEl.innerHTML = ''; }, 3000);
        } else {
          msgEl.innerHTML = `<p class="text-red-600 text-sm">${data.error || 'Failed to add'}</p>`;
        }
      } catch (err) {
        console.error('Error adding to whitelist:', err);
        msgEl.innerHTML = '<p class="text-red-600 text-sm">Error adding to whitelist</p>';
      }
    };

    window.removeFromWhitelist = async function(email) {
      if (!confirm(`Remove ${email} from whitelist?`)) return;

      try {
        const res = await fetch(`/dashboard/api/admin/whitelist/${encodeURIComponent(email)}`, {
          method: 'DELETE'
        });
        const data = await res.json();

        if (res.ok && data.success) {
          loadWhitelist();
        } else {
          alert(data.error || 'Failed to remove');
        }
      } catch (err) {
        console.error('Error removing from whitelist:', err);
        alert('Error removing from whitelist');
      }
    };

    // ========== Container Events Toast Notifications ==========
    const toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-sm';
    document.body.appendChild(toastContainer);

    const toastColors = {
      success: 'bg-green-500',
      warning: 'bg-yellow-500',
      error: 'bg-red-500',
      info: 'bg-blue-500'
    };

    const toastIcons = {
      success: 'fa-check-circle',
      warning: 'fa-exclamation-triangle',
      error: 'fa-times-circle',
      info: 'fa-info-circle'
    };

    function showToast(message, type = 'info', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `${toastColors[type] || toastColors.info} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform translate-x-full opacity-0 transition-all duration-300`;
      toast.innerHTML = `
        <i class="fas ${toastIcons[type] || toastIcons.info}"></i>
        <span class="flex-1 text-sm">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      `;
      toastContainer.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
      });

      // Auto-remove after duration
      setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Connect to container events SSE stream
    let eventSource = null;
    let reconnectAttempts = 0;

    function connectContainerEvents() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/api/events/containers');

      eventSource.onopen = () => {
        console.log('[SSE] Connected to container events');
        reconnectAttempts = 0;
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'error' && data.retry === false) {
            // Service not available, don't reconnect
            console.log('[SSE] Container events not available:', data.message);
            eventSource.close();
            eventSource = null;
            return;
          }
          if (data.type === 'connected') {
            showToast('Container events connected', 'success', 2000);
          } else if (data.message) {
            showToast(data.message, data.type || 'info');
          }
        } catch (e) {
          console.error('[SSE] Parse error:', e);
        }
      };

      eventSource.onerror = (e) => {
        console.error('[SSE] Connection error, reconnecting...');
        eventSource.close();
        reconnectAttempts++;
        // Exponential backoff: 1s, 2s, 4s, 8s, max 30s
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000);
        setTimeout(connectContainerEvents, delay);
      };
    }

    // Start SSE connection
    connectContainerEvents();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (eventSource) eventSource.close();
    });
    <% } %>
  </script>

  <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
  <script>
    // ==================== Infra Services ====================
    const INFRA_API = '/dashboard/api/infra';
    let infraRefreshInterval = null;
    let infraServicesCache = [];

    // Escape HTML helper for infra script scope
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadInfraServices() {
      try {
        const res = await fetch(INFRA_API);
        const data = await res.json();
        const grid = document.getElementById('infra-grid');
        infraServicesCache = data.services || [];

        if (infraServicesCache.length === 0) {
          grid.innerHTML = `
            <div class="text-center py-8 text-gray-500 col-span-full">
              <i class="fas fa-box-open text-4xl mb-3"></i>
              <p class="text-lg font-medium">No infrastructure services deployed</p>
              <p class="text-sm mt-1">Click "Deploy New Service" to get started.</p>
            </div>`;
          return;
        }

        grid.innerHTML = infraServicesCache.map(svc => renderInfraCard(svc)).join('');
      } catch (err) {
        console.error('Error loading infra services:', err);
        document.getElementById('infra-grid').innerHTML = `
          <div class="text-center py-8 text-red-500 col-span-full">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <p>Error loading infrastructure services.</p>
            <button onclick="loadInfraServices()" class="mt-2 px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">Retry</button>
          </div>`;
      }
    }

    function getStatusColor(status) {
      switch ((status || '').toLowerCase()) {
        case 'running': return { bg: 'bg-green-100', text: 'text-green-800', dot: 'bg-green-500' };
        case 'stopped': return { bg: 'bg-gray-100', text: 'text-gray-800', dot: 'bg-gray-500' };
        case 'degraded': return { bg: 'bg-yellow-100', text: 'text-yellow-800', dot: 'bg-yellow-500' };
        case 'pending': return { bg: 'bg-blue-100', text: 'text-blue-800', dot: 'bg-blue-500' };
        default: return { bg: 'bg-gray-100', text: 'text-gray-800', dot: 'bg-gray-500' };
      }
    }

    function renderInfraCard(svc) {
      const status = getStatusColor(svc.status);
      const image = svc.image || 'N/A';
      const truncImage = image.length > 40 ? image.substring(0, 37) + '...' : image;
      const readyPods = svc.pods ? svc.pods.filter(p => p.ready).length : 0;
      const totalPods = svc.pods ? svc.pods.length : 0;
      const cpu = svc.cpu || 'N/A';
      const memory = svc.memory || 'N/A';
      const safeName = escapeHtml(svc.name);

      return `
        <div class="border rounded-lg p-4 bg-gray-50 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-900 truncate">${safeName}</h4>
              <p class="text-xs text-gray-500 font-mono truncate" title="${escapeHtml(image)}">${escapeHtml(truncImage)}</p>
            </div>
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${status.bg} ${status.text} shrink-0 ml-2">
              <span class="w-2 h-2 rounded-full ${status.dot}"></span>
              ${escapeHtml(svc.status || 'unknown')}
            </span>
          </div>

          <div class="grid grid-cols-3 gap-2 mb-3 text-xs text-gray-600">
            <div class="flex items-center gap-1">
              <i class="fas fa-microchip text-blue-500"></i>
              <span>${escapeHtml(String(cpu))}</span>
            </div>
            <div class="flex items-center gap-1">
              <i class="fas fa-memory text-purple-500"></i>
              <span>${escapeHtml(String(memory))}</span>
            </div>
            <div class="flex items-center gap-1">
              <i class="fas fa-cubes text-green-500"></i>
              <span>${readyPods}/${totalPods} pods</span>
            </div>
          </div>

          <div class="flex flex-wrap gap-1">
            <button onclick="startInfraService('${safeName}')" class="px-2 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700" title="Start">
              <i class="fas fa-play"></i>
            </button>
            <button onclick="stopInfraService('${safeName}')" class="px-2 py-1 rounded bg-gray-600 text-white text-xs hover:bg-gray-700" title="Stop">
              <i class="fas fa-stop"></i>
            </button>
            <button onclick="restartInfraService('${safeName}')" class="px-2 py-1 rounded bg-yellow-600 text-white text-xs hover:bg-yellow-700" title="Restart">
              <i class="fas fa-redo"></i>
            </button>
            <button onclick="viewInfraLogs('${safeName}')" class="px-2 py-1 rounded bg-purple-600 text-white text-xs hover:bg-purple-700" title="Logs">
              <i class="fas fa-scroll"></i>
            </button>
            <button onclick="openInfraTerminal('${safeName}')" class="px-2 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700" title="Shell">
              <i class="fas fa-terminal"></i>
            </button>
            <button onclick="viewInfraDetail('${safeName}')" class="px-2 py-1 rounded bg-indigo-600 text-white text-xs hover:bg-indigo-700" title="Details">
              <i class="fas fa-info-circle"></i>
            </button>
            <button onclick="deleteInfraService('${safeName}')" class="px-2 py-1 rounded bg-red-600 text-white text-xs hover:bg-red-700" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>`;
    }

    async function startInfraService(name) {
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name) + '/start', { method: 'POST' });
        const data = await res.json();
        if (data.error) {
          alert('Error starting service: ' + data.error);
        }
        loadInfraServices();
      } catch (err) {
        console.error('Error starting infra service:', err);
        alert('Failed to start service.');
      }
    }

    async function stopInfraService(name) {
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name) + '/stop', { method: 'POST' });
        const data = await res.json();
        if (data.error) {
          alert('Error stopping service: ' + data.error);
        }
        loadInfraServices();
      } catch (err) {
        console.error('Error stopping infra service:', err);
        alert('Failed to stop service.');
      }
    }

    async function restartInfraService(name) {
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name) + '/restart', { method: 'POST' });
        const data = await res.json();
        if (data.error) {
          alert('Error restarting service: ' + data.error);
        }
        loadInfraServices();
      } catch (err) {
        console.error('Error restarting infra service:', err);
        alert('Failed to restart service.');
      }
    }

    async function deleteInfraService(name) {
      if (!confirm('Are you sure you want to delete "' + name + '"? This action cannot be undone.')) return;
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name), { method: 'DELETE' });
        const data = await res.json();
        if (data.error) {
          alert('Error deleting service: ' + data.error);
        }
        loadInfraServices();
      } catch (err) {
        console.error('Error deleting infra service:', err);
        alert('Failed to delete service.');
      }
    }

    async function viewInfraLogs(name) {
      document.getElementById('infra-logs-title').textContent = name;
      document.getElementById('infra-logs-output').textContent = 'Loading logs...';
      document.getElementById('infra-logs-modal').classList.remove('hidden');
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name) + '/logs');
        const data = await res.json();
        document.getElementById('infra-logs-output').textContent = data.logs || 'No logs available.';
      } catch (err) {
        console.error('Error fetching infra logs:', err);
        document.getElementById('infra-logs-output').textContent = 'Error fetching logs.';
      }
    }

    async function viewInfraDetail(name) {
      document.getElementById('infra-detail-title').textContent = name;
      document.getElementById('infra-detail-content').innerHTML = '<p class="text-gray-500 text-center">Loading details...</p>';
      document.getElementById('infra-detail-modal').classList.remove('hidden');
      try {
        const res = await fetch(INFRA_API + '/' + encodeURIComponent(name));
        const svc = await res.json();
        const pods = svc.pods || [];
        const ports = svc.ports || [];

        let podsHtml = '';
        if (pods.length > 0) {
          podsHtml = `
            <div>
              <h4 class="font-semibold text-sm mb-2"><i class="fas fa-cubes text-green-600"></i> Pods</h4>
              <div class="space-y-2">
                ${pods.map(p => {
                  const pStatus = getStatusColor(p.ready ? 'running' : (p.status || 'pending'));
                  return `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border text-sm">
                      <span class="font-mono text-xs truncate flex-1">${escapeHtml(p.name)}</span>
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${pStatus.bg} ${pStatus.text} ml-2">
                        <span class="w-1.5 h-1.5 rounded-full ${pStatus.dot}"></span>
                        ${p.ready ? 'Ready' : (escapeHtml(p.status) || 'Pending')}
                      </span>
                    </div>`;
                }).join('')}
              </div>
            </div>`;
        }

        let portsHtml = '';
        if (ports.length > 0) {
          portsHtml = `
            <div>
              <h4 class="font-semibold text-sm mb-2"><i class="fas fa-network-wired text-blue-600"></i> Ports</h4>
              <div class="flex flex-wrap gap-2">
                ${ports.map(p => `
                  <span class="inline-block px-2 py-1 bg-blue-50 border border-blue-200 rounded text-xs font-mono">
                    ${escapeHtml(String(p.port || p))}${p.protocol ? '/' + escapeHtml(p.protocol) : ''}
                  </span>`).join('')}
              </div>
            </div>`;
        }

        let resourcesHtml = `
          <div>
            <h4 class="font-semibold text-sm mb-2"><i class="fas fa-chart-bar text-purple-600"></i> Resources</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="p-2 bg-gray-50 rounded border">
                <span class="text-gray-500 text-xs">CPU</span>
                <p class="font-medium">${escapeHtml(String(svc.cpu || 'N/A'))}</p>
              </div>
              <div class="p-2 bg-gray-50 rounded border">
                <span class="text-gray-500 text-xs">Memory</span>
                <p class="font-medium">${escapeHtml(String(svc.memory || 'N/A'))}</p>
              </div>
            </div>
          </div>`;

        document.getElementById('infra-detail-content').innerHTML =
          `<div class="space-y-4">${resourcesHtml}${podsHtml}${portsHtml}</div>`;
      } catch (err) {
        console.error('Error fetching infra details:', err);
        document.getElementById('infra-detail-content').innerHTML =
          '<p class="text-red-500 text-center"><i class="fas fa-exclamation-circle mr-1"></i>Error loading service details.</p>';
      }
    }

    function openInfraTerminal(name) {
      // Find the first pod name from cached service data
      const svc = infraServicesCache.find(s => s.name === name);
      if (!svc || !svc.pods || svc.pods.length === 0) {
        alert('No pods available for this service. Make sure the service is running.');
        return;
      }
      const podName = svc.pods[0].name;

      const w = window.open('', '_blank', 'width=1000,height=700');
      const doc = w.document;

      doc.open();
      doc.write('<!DOCTYPE html><html><head><title>Shell: ' + escapeHtml(podName) + '</title></head><body></body></html>');
      doc.close();

      // Add stylesheet
      const link = doc.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css';
      doc.head.appendChild(link);

      // Add styles
      const style = doc.createElement('style');
      style.textContent = 'body { margin: 0; padding: 0; background: #000; } #terminal { height: 100vh; padding: 8px; }';
      doc.head.appendChild(style);

      // Add terminal div
      const terminalDiv = doc.createElement('div');
      terminalDiv.id = 'terminal';
      doc.body.appendChild(terminalDiv);

      // Load xterm.js and initialize
      const script = doc.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js';
      script.onload = function () {
        const term = new w.Terminal({
          convertEol: true,
          fontFamily: 'monospace',
          fontSize: 14,
          cursorBlink: true,
          theme: { background: '#000000', foreground: '#ffffff' }
        });
        term.open(doc.getElementById('terminal'));
        term.writeln('Connecting to pod ' + podName + '...');

        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(proto + '://' + location.host + '/dashboard/ws/infra/' + encodeURIComponent(podName) + '/exec');
        ws.binaryType = 'arraybuffer';
        ws.onopen = function () { term.clear(); term.writeln('Connected! Type commands below:'); term.write('$ '); };
        ws.onmessage = function (ev) { term.write(new Uint8Array(ev.data)); };
        ws.onclose = function () { term.writeln('\r\n[Connection closed]'); };
        ws.onerror = function () { term.writeln('\r\n[Connection error]'); };
        term.onData(function (data) { if (ws.readyState === WebSocket.OPEN) ws.send(data); });
      };
      doc.head.appendChild(script);
    }

    async function deployFromCompose() {
      const name = document.getElementById('compose-service-name').value.trim();
      const compose = document.getElementById('compose-yaml').value.trim();
      const msgDiv = document.getElementById('deploy-message');

      if (!name || !compose) {
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Please provide both a service name and Compose YAML.</p>';
        return;
      }

      msgDiv.innerHTML = '<p class="text-blue-600 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i>Deploying...</p>';
      try {
        const res = await fetch(INFRA_API + '/deploy/compose', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, compose })
        });
        const data = await res.json();
        if (data.error) {
          msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">' + escapeHtml(data.error) + '</p>';
        } else {
          msgDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm"><i class="fas fa-check mr-1"></i>Service deployed successfully!</p>';
          document.getElementById('compose-service-name').value = '';
          document.getElementById('compose-yaml').value = '';
          loadInfraServices();
        }
      } catch (err) {
        console.error('Error deploying from compose:', err);
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Deployment failed. Please try again.</p>';
      }
    }

    async function deployFromGithub() {
      const repoUrl = document.getElementById('github-repo-url').value.trim();
      const branch = document.getElementById('github-branch').value.trim() || undefined;
      const msgDiv = document.getElementById('deploy-message');

      if (!repoUrl) {
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Please provide a repository URL.</p>';
        return;
      }

      msgDiv.innerHTML = '<p class="text-blue-600 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i>Deploying...</p>';
      try {
        const body = { repoUrl };
        if (branch) body.branch = branch;
        const res = await fetch(INFRA_API + '/deploy/github', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.error) {
          msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">' + escapeHtml(data.error) + '</p>';
        } else {
          msgDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm"><i class="fas fa-check mr-1"></i>Service deployed successfully from GitHub!</p>';
          document.getElementById('github-repo-url').value = '';
          document.getElementById('github-branch').value = '';
          loadInfraServices();
        }
      } catch (err) {
        console.error('Error deploying from GitHub:', err);
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Deployment failed. Please try again.</p>';
      }
    }

    async function deployFromManifest() {
      const manifests = document.getElementById('k8s-manifest').value.trim();
      const msgDiv = document.getElementById('deploy-message');

      if (!manifests) {
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Please provide Kubernetes YAML manifests.</p>';
        return;
      }

      msgDiv.innerHTML = '<p class="text-blue-600 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i>Deploying...</p>';
      try {
        const res = await fetch(INFRA_API + '/deploy/manifest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ manifests })
        });
        const data = await res.json();
        if (data.error) {
          msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">' + escapeHtml(data.error) + '</p>';
        } else {
          msgDiv.innerHTML = '<p class="text-green-700 bg-green-100 border border-green-200 rounded p-2 text-sm"><i class="fas fa-check mr-1"></i>Manifests applied successfully!</p>';
          document.getElementById('k8s-manifest').value = '';
          loadInfraServices();
        }
      } catch (err) {
        console.error('Error deploying manifest:', err);
        msgDiv.innerHTML = '<p class="text-red-700 bg-red-100 border border-red-200 rounded p-2 text-sm">Deployment failed. Please try again.</p>';
      }
    }

    function switchDeployTab(tab) {
      const tabs = ['compose', 'github', 'manifest'];
      tabs.forEach(t => {
        const panel = document.getElementById('deploy-panel-' + t);
        const btn = document.getElementById('deploy-tab-' + t);
        if (t === tab) {
          panel.classList.remove('hidden');
          btn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
          btn.classList.remove('text-gray-600');
        } else {
          panel.classList.add('hidden');
          btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
          btn.classList.add('text-gray-600');
        }
      });
      // Clear deploy message on tab switch
      document.getElementById('deploy-message').innerHTML = '';
    }

    // Auto-refresh infra services when tab is active
    function startInfraRefresh() {
      if (infraRefreshInterval) clearInterval(infraRefreshInterval);
      loadInfraServices();
      infraRefreshInterval = setInterval(loadInfraServices, 10000);
    }

    function stopInfraRefresh() {
      if (infraRefreshInterval) {
        clearInterval(infraRefreshInterval);
        infraRefreshInterval = null;
      }
    }

    // Hook into tab switching to start/stop auto-refresh
    document.addEventListener('DOMContentLoaded', function () {
      const infraTab = document.getElementById('tab-infra');
      if (infraTab) {
        infraTab.addEventListener('click', function () {
          startInfraRefresh();
        });

        // Stop refresh when other tabs are clicked
        const otherTabs = ['tab-containers', 'tab-openwebui', 'tab-n8n', 'tab-minecraft'];
        otherTabs.forEach(function (tabId) {
          const tabBtn = document.getElementById(tabId);
          if (tabBtn) {
            tabBtn.addEventListener('click', function () {
              stopInfraRefresh();
            });
          }
        });
      }
    });
  </script>
  <% } %>

  <!-- Interactive Tutorial System -->
  <div id="tutorial-overlay" class="tutorial-overlay"></div>
  <div id="tutorial-spotlight" class="tutorial-spotlight" style="display: none;"></div>
  <div id="tutorial-tooltip" class="tutorial-tooltip" style="display: none;"></div>
  <div id="tutorial-welcome" class="tutorial-welcome" style="display: none;"></div>

  <script>
  // ==================== Interactive Tutorial System ====================
  (function() {
    const TUTORIAL_VERSION = '1.0';
    const STORAGE_KEY = 'hydra_tutorial_completed';

    // Tutorial steps configuration
    const tutorialSteps = [
      {
        type: 'welcome',
        title: 'Welcome to Hydra!',
        icon: '<img src="https://hydra.newpaltz.edu/SUNYCAT.png" alt="Hydra" style="width: 60px; height: 60px; border-radius: 12px;">',
        content: `
          <p style="color: #6b7280; margin-bottom: 16px;">Your personal development environment at SUNY New Paltz</p>
          <ul class="tutorial-feature-list">
            <li><i class="fas fa-cube"></i> Personal Linux container with full terminal access</li>
            <li><i class="fas fa-code"></i> VS Code in browser (code-server)</li>
            <li><i class="fas fa-bolt"></i> GPU access for ML/AI workloads</li>
            <li><i class="fas fa-robot"></i> OpenWebUI for AI chat models</li>
            <li><i class="fas fa-cogs"></i> n8n workflow automation</li>
          </ul>
        `,
        showRoutes: false
      },
      {
        type: 'highlight',
        target: '#container-status-section',
        title: 'Container Status',
        content: `
          <p>This shows your container's current state and allocated resources.</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-microchip"></i> <strong>CPU</strong> - Processing cores allocated</li>
            <li><i class="fas fa-memory"></i> <strong>RAM</strong> - Memory for your applications</li>
            <li><i class="fas fa-hdd"></i> <strong>Storage</strong> - Persistent disk space</li>
            <li><i class="fas fa-server"></i> <strong>Node</strong> - Which server hosts your container</li>
          </ul>
        `,
        route: {
          method: 'GET',
          path: '/dashboard/api/containers/status',
          desc: 'Fetches container state and resource info'
        },
        position: 'bottom'
      },
      {
        type: 'highlight',
        target: '#container-controls',
        title: 'Container Controls',
        content: `
          <p>Manage your container with these controls:</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-play" style="color: #22c55e;"></i> <strong>Start</strong> - Boot your container</li>
            <li><i class="fas fa-stop" style="color: #ef4444;"></i> <strong>Stop</strong> - Shut down gracefully</li>
            <li><i class="fas fa-terminal" style="color: #3b82f6;"></i> <strong>Terminal</strong> - Opens VS Code in browser</li>
            <li><i class="fas fa-cog" style="color: #8b5cf6;"></i> <strong>Configure</strong> - Request more resources</li>
          </ul>
        `,
        route: {
          method: 'POST',
          path: '/dashboard/api/containers/{start|stop}',
          desc: 'Controls container lifecycle'
        },
        position: 'bottom'
      },
      {
        type: 'highlight',
        target: '#resource-config-btn',
        title: 'Resource Configuration',
        content: `
          <p>Need more power? Click <strong>Configure</strong> to request:</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-arrow-up"></i> More CPU cores or RAM</li>
            <li><i class="fas fa-bolt"></i> GPU access on Chimera/Cerberus</li>
            <li><i class="fas fa-hdd"></i> Additional storage space</li>
          </ul>
          <p style="color: #6b7280; font-size: 13px; margin-top: 8px;">
            <i class="fas fa-info-circle"></i> Some resources require admin approval
          </p>
        `,
        route: {
          method: 'POST',
          path: '/dashboard/api/resource-requests',
          desc: 'Submit resource upgrade request'
        },
        position: 'left'
      },
      {
        type: 'highlight',
        target: '#terminal-btn',
        title: 'Terminal Access (VS Code)',
        content: `
          <p>Opens <strong>code-server</strong> - VS Code running in your browser!</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-folder"></i> Full file system access</li>
            <li><i class="fas fa-terminal"></i> Integrated terminal</li>
            <li><i class="fas fa-puzzle-piece"></i> Extension support</li>
            <li><i class="fas fa-code-branch"></i> Git integration</li>
          </ul>
          <p style="color: #6b7280; font-size: 13px;">
            Access at: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">https://hydra.newpaltz.edu/vscode/</code>
          </p>
        `,
        route: {
          method: 'GET',
          path: '/vscode/',
          desc: 'Proxied code-server instance'
        },
        position: 'left'
      },
      {
        type: 'highlight',
        target: '#tab-openwebui',
        title: 'OpenWebUI - AI Chat',
        content: `
          <p>Access AI language models through a ChatGPT-like interface.</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-comments"></i> Chat with various AI models</li>
            <li><i class="fas fa-user"></i> Create your account here</li>
            <li><i class="fas fa-key"></i> Manage your credentials</li>
          </ul>
          <p style="color: #6b7280; font-size: 13px;">
            Available at: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">https://gpt.hydra.newpaltz.edu</code>
          </p>
        `,
        route: {
          method: 'POST',
          path: '/dashboard/api/webui/account',
          desc: 'Create/manage OpenWebUI account'
        },
        position: 'bottom'
      },
      {
        type: 'highlight',
        target: '#tab-n8n',
        title: 'n8n - Workflow Automation',
        content: `
          <p>Build automated workflows with a visual editor.</p>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-project-diagram"></i> Connect apps and services</li>
            <li><i class="fas fa-clock"></i> Schedule automated tasks</li>
            <li><i class="fas fa-webhook"></i> Trigger workflows via webhooks</li>
          </ul>
          <p style="color: #6b7280; font-size: 13px;">
            Available at: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">https://n8n.hydra.newpaltz.edu</code>
          </p>
        `,
        route: {
          method: 'POST',
          path: '/dashboard/api/n8n/account',
          desc: 'Create/manage n8n account'
        },
        position: 'bottom'
      },
      {
        type: 'info',
        title: 'GPU Nodes: Chimera & Cerberus',
        icon: '<i class="fas fa-microchip" style="color: white;"></i>',
        content: `
          <p style="color: #6b7280; margin-bottom: 16px;">For ML/AI workloads, request migration to a GPU node:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
              <strong style="color: #92400e;">Chimera</strong>
              <p style="font-size: 12px; color: #92400e;">3× RTX 3090 (24GB each)</p>
              <p style="font-size: 11px; color: #a16207;">Best for inference</p>
            </div>
            <div style="background: #dbeafe; padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">Cerberus</strong>
              <p style="font-size: 12px; color: #1e40af;">2× RTX 5090 (32GB each)</p>
              <p style="font-size: 11px; color: #1d4ed8;">Best for training</p>
            </div>
          </div>
        `,
        route: {
          method: 'POST',
          path: '/dashboard/api/containers/migrate',
          desc: 'Migrate container to GPU node'
        }
      },
      <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
      {
        type: 'info',
        title: 'Admin Panel',
        icon: '<i class="fas fa-shield-alt" style="color: white;"></i>',
        content: `
          <p style="color: #6b7280; margin-bottom: 16px;">As an admin, you can approve resource requests from users.</p>
          <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <i class="fas fa-bell" style="color: #d97706; font-size: 24px;"></i>
              <div>
                <p style="font-weight: 600; color: #92400e;">Look for the bell icon</p>
                <p style="font-size: 12px; color: #a16207;">Bottom-right corner of the screen</p>
              </div>
            </div>
          </div>
          <ul class="tutorial-feature-list" style="margin: 12px 0;">
            <li><i class="fas fa-check"></i> Approve GPU/resource requests</li>
            <li><i class="fas fa-times"></i> Deny with feedback</li>
            <li><i class="fas fa-users"></i> Monitor all pending requests</li>
            <li><i class="fas fa-check-double"></i> Bulk approve all requests</li>
          </ul>
        `,
        route: {
          method: 'GET',
          path: '/dashboard/api/admin/requests',
          desc: 'List all pending approval requests'
        }
      },
      <% } %>
      {
        type: 'info',
        title: 'API Routes Overview',
        icon: '<i class="fas fa-route" style="color: white;"></i>',
        content: `
          <p style="color: #6b7280; margin-bottom: 12px;">Hydra uses these main API endpoints:</p>
          <div class="tutorial-route-box">
            <div><span class="route-method">GET</span> <span class="route-path">/dashboard/api/containers/status</span></div>
            <div style="margin-top: 4px;"><span class="route-method">POST</span> <span class="route-path">/dashboard/api/containers/{start|stop}</span></div>
            <div style="margin-top: 4px;"><span class="route-method">POST</span> <span class="route-path">/dashboard/api/resource-requests</span></div>
            <div style="margin-top: 4px;"><span class="route-method">GET</span> <span class="route-path">/dashboard/api/resource-requests/my</span></div>
            <div style="margin-top: 4px;"><span class="route-method">POST</span> <span class="route-path">/dashboard/api/containers/migrate</span></div>
          </div>
          <p style="color: #9ca3af; font-size: 12px; margin-top: 8px;">
            All routes require authentication via SAML SSO
          </p>
        `
      },
      {
        type: 'complete',
        title: "You're All Set!",
        icon: '<i class="fas fa-check" style="color: white;"></i>',
        content: `
          <p style="color: #6b7280; margin-bottom: 16px;">You now know how to use the Hydra dashboard!</p>
          <ul class="tutorial-feature-list">
            <li><i class="fas fa-play"></i> Start your container to begin coding</li>
            <li><i class="fas fa-terminal"></i> Use Terminal for VS Code access</li>
            <li><i class="fas fa-cog"></i> Configure resources when needed</li>
            <li><i class="fas fa-question-circle"></i> Click the cat logo to replay this tour</li>
          </ul>
        `
      }
    ];

    let currentStep = 0;
    let isActive = false;

    // DOM elements
    const overlay = document.getElementById('tutorial-overlay');
    const spotlight = document.getElementById('tutorial-spotlight');
    const tooltip = document.getElementById('tutorial-tooltip');
    const welcome = document.getElementById('tutorial-welcome');

    // Check if tutorial should show
    function shouldShowTutorial() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const data = JSON.parse(stored);
          return data.version !== TUTORIAL_VERSION;
        } catch (e) {
          return true;
        }
      }
      return true;
    }

    // Mark tutorial as completed
    function completeTutorial() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        version: TUTORIAL_VERSION,
        completedAt: new Date().toISOString()
      }));
    }

    // Start tutorial
    function startTutorial() {
      currentStep = 0;
      isActive = true;
      overlay.classList.add('active');
      showStep(currentStep);
    }

    // End tutorial
    function endTutorial(completed = true) {
      isActive = false;
      overlay.classList.remove('active');
      spotlight.style.display = 'none';
      tooltip.style.display = 'none';
      tooltip.classList.remove('visible');
      welcome.style.display = 'none';
      welcome.classList.remove('visible');
      if (completed) {
        completeTutorial();
      }
    }

    // Show a specific step
    function showStep(index) {
      const step = tutorialSteps[index];
      if (!step) {
        endTutorial(true);
        return;
      }

      // Hide previous elements
      spotlight.style.display = 'none';
      tooltip.style.display = 'none';
      tooltip.classList.remove('visible');
      welcome.style.display = 'none';
      welcome.classList.remove('visible');

      if (step.type === 'welcome' || step.type === 'info' || step.type === 'complete') {
        showWelcomeStep(step, index);
      } else if (step.type === 'highlight') {
        showHighlightStep(step, index);
      }
    }

    // Show welcome/info/complete step (centered modal)
    function showWelcomeStep(step, index) {
      const isLast = index === tutorialSteps.length - 1;
      const routeHtml = step.route ? `
        <div class="tutorial-route-box">
          <span class="route-method">${step.route.method}</span>
          <span class="route-path">${step.route.path}</span>
          <div style="color: #9ca3af; font-size: 11px; margin-top: 4px;">${step.route.desc}</div>
        </div>
      ` : '';

      welcome.innerHTML = `
        <div class="tutorial-icon">${step.icon}</div>
        <h2 style="font-size: 24px; font-weight: 600; color: #1f2937; margin-bottom: 12px;">${step.title}</h2>
        ${step.content}
        ${routeHtml}
        <div class="tutorial-progress">
          ${tutorialSteps.map((_, i) => `
            <div class="tutorial-progress-dot ${i < index ? 'completed' : ''} ${i === index ? 'active' : ''}"></div>
          `).join('')}
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: center;">
          <button class="tutorial-btn tutorial-btn-skip" onclick="window.hydra_tutorial.skip()">
            Skip All
          </button>
          ${index > 0 ? `
            <button class="tutorial-btn tutorial-btn-secondary" onclick="window.hydra_tutorial.prev()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          ` : ''}
          <button class="tutorial-btn tutorial-btn-primary" onclick="window.hydra_tutorial.${isLast ? 'finish' : 'next'}()">
            ${isLast ? 'Get Started' : (index === 0 ? 'Start Tour' : 'Next')} ${isLast ? '' : '<i class="fas fa-arrow-right"></i>'}
          </button>
        </div>
      `;

      welcome.style.display = 'block';
      setTimeout(() => welcome.classList.add('visible'), 10);
    }

    // Show highlight step (spotlight + tooltip)
    function showHighlightStep(step, index) {
      const target = document.querySelector(step.target);
      if (!target) {
        // Skip if target not found
        nextStep();
        return;
      }

      // Scroll target into view
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });

      setTimeout(() => {
        // Position spotlight
        const rect = target.getBoundingClientRect();
        const padding = 8;
        spotlight.style.display = 'block';
        spotlight.style.left = (rect.left - padding + window.scrollX) + 'px';
        spotlight.style.top = (rect.top - padding + window.scrollY) + 'px';
        spotlight.style.width = (rect.width + padding * 2) + 'px';
        spotlight.style.height = (rect.height + padding * 2) + 'px';

        // Build tooltip content
        const isLast = index === tutorialSteps.length - 1;
        const routeHtml = step.route ? `
          <div class="tutorial-route-box">
            <span class="route-method">${step.route.method}</span>
            <span class="route-path">${step.route.path}</span>
            <div style="color: #9ca3af; font-size: 11px; margin-top: 4px;">${step.route.desc}</div>
          </div>
        ` : '';

        tooltip.innerHTML = `
          <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            ${step.title}
          </h3>
          ${step.content}
          ${routeHtml}
          <div class="tutorial-progress">
            ${tutorialSteps.map((_, i) => `
              <div class="tutorial-progress-dot ${i < index ? 'completed' : ''} ${i === index ? 'active' : ''}"></div>
            `).join('')}
          </div>
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button class="tutorial-btn tutorial-btn-skip" onclick="window.hydra_tutorial.skip()">
              Skip
            </button>
            <button class="tutorial-btn tutorial-btn-secondary" onclick="window.hydra_tutorial.prev()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <button class="tutorial-btn tutorial-btn-primary" onclick="window.hydra_tutorial.${isLast ? 'finish' : 'next'}()">
              ${isLast ? 'Finish' : 'Next'} <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        `;

        // Position tooltip
        positionTooltip(rect, step.position || 'bottom');
        tooltip.style.display = 'block';
        setTimeout(() => tooltip.classList.add('visible'), 10);
      }, 400);
    }

    // Position tooltip relative to target
    function positionTooltip(targetRect, position) {
      const tooltipRect = tooltip.getBoundingClientRect();
      const margin = 20;
      let left, top;

      // Remove old arrow classes
      tooltip.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right');

      switch (position) {
        case 'bottom':
          left = targetRect.left;
          top = targetRect.bottom + margin;
          tooltip.classList.add('arrow-top');
          break;
        case 'top':
          left = targetRect.left;
          top = targetRect.top - tooltipRect.height - margin;
          tooltip.classList.add('arrow-bottom');
          break;
        case 'left':
          left = targetRect.left - tooltipRect.width - margin;
          top = targetRect.top;
          tooltip.classList.add('arrow-right');
          break;
        case 'right':
          left = targetRect.right + margin;
          top = targetRect.top;
          tooltip.classList.add('arrow-left');
          break;
      }

      // Keep tooltip in viewport
      const maxLeft = window.innerWidth - tooltipRect.width - 20;
      const maxTop = window.innerHeight - tooltipRect.height - 20;
      left = Math.max(20, Math.min(left, maxLeft));
      top = Math.max(20, Math.min(top, maxTop));

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    // Navigation functions
    function nextStep() {
      if (currentStep < tutorialSteps.length - 1) {
        currentStep++;
        showStep(currentStep);
      } else {
        endTutorial(true);
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    }

    function skipTutorial() {
      endTutorial(true);
    }

    function finishTutorial() {
      endTutorial(true);
    }

    // Expose to global scope
    window.hydra_tutorial = {
      start: startTutorial,
      next: nextStep,
      prev: prevStep,
      skip: skipTutorial,
      finish: finishTutorial,
      reset: function() {
        localStorage.removeItem(STORAGE_KEY);
        startTutorial();
      }
    };

    // Add click handler to hydra cat logo to restart tutorial
    document.addEventListener('DOMContentLoaded', function() {
      const hydraCat = document.getElementById('hydra-cat');
      if (hydraCat) {
        hydraCat.title = 'Click to replay the tutorial';
        hydraCat.addEventListener('click', function() {
          window.hydra_tutorial.reset();
        });
      }

      // Auto-start tutorial for first-time users
      if (shouldShowTutorial()) {
        setTimeout(startTutorial, 500);
      }
    });

    // Handle escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && isActive) {
        skipTutorial();
      }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (isActive && tutorialSteps[currentStep]?.type === 'highlight') {
        showStep(currentStep);
      }
    });
  })();
  </script>
</body>

</html>