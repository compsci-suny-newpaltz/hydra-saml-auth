# vLLM Cluster - Cerberus Worker Node
# IP: 192.168.1.242
# GPUs: 2x RTX 5090 (64GB VRAM)

services:
  ray-worker:
    image: rayproject/ray:2.35.0-py311-gpu
    container_name: ray-worker
    hostname: cerberus-ray
    network_mode: host
    ipc: host
    privileged: true
    volumes:
      - /dev/infiniband:/dev/infiniband:ro
      - /models:/root/.cache/huggingface
    environment:
      # Soft-RoCE configuration (for software RDMA)
      # Uncomment if using Soft-RoCE:
      # - NCCL_IB_HCA=rxe0
      # - NCCL_NET_GDR_LEVEL=0
      # - NCCL_IB_GID_INDEX=3
      # Hardware RDMA configuration (for Mellanox):
      # - NCCL_IB_HCA=mlx5_0
      # Standard TCP fallback (current setup):
      - NCCL_SOCKET_IFNAME=wlp227s0
      - NCCL_DEBUG=INFO
      - CUDA_VISIBLE_DEVICES=0,1
    command: ray start --address=192.168.1.150:6379 --block
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

volumes: {}
