\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{array}
\usepackage{fancyhdr}
\usepackage{enumitem}
\usepackage{float}
\usepackage{mdframed}
\usepackage{longtable}

\geometry{margin=1in}

\definecolor{hydra-blue}{RGB}{5,32,73}
\definecolor{code-bg}{RGB}{248,248,248}
\definecolor{warning-bg}{RGB}{255,243,205}
\definecolor{success-bg}{RGB}{212,237,218}
\definecolor{info-bg}{RGB}{217,237,247}
\definecolor{danger-bg}{RGB}{248,215,218}
\definecolor{done-bg}{RGB}{200,230,201}

\hypersetup{colorlinks=true,linkcolor=hydra-blue,urlcolor=blue}

\lstdefinestyle{bash}{backgroundcolor=\color{code-bg},basicstyle=\ttfamily\small,breaklines=true,frame=single,numbers=none}
\lstdefinestyle{yaml}{backgroundcolor=\color{code-bg},basicstyle=\ttfamily\small,breaklines=true,frame=single,numbers=left}

\newmdenv[backgroundcolor=warning-bg,linewidth=0pt,innerleftmargin=10pt,innerrightmargin=10pt,innertopmargin=10pt,innerbottommargin=10pt]{warningbox}
\newmdenv[backgroundcolor=success-bg,linewidth=0pt,innerleftmargin=10pt,innerrightmargin=10pt,innertopmargin=10pt,innerbottommargin=10pt]{successbox}
\newmdenv[backgroundcolor=info-bg,linewidth=0pt,innerleftmargin=10pt,innerrightmargin=10pt,innertopmargin=10pt,innerbottommargin=10pt]{infobox}
\newmdenv[backgroundcolor=danger-bg,linewidth=0pt,innerleftmargin=10pt,innerrightmargin=10pt,innertopmargin=10pt,innerbottommargin=10pt]{dangerbox}
\newmdenv[backgroundcolor=done-bg,linewidth=2pt,linecolor=green!50!black,innerleftmargin=10pt,innerrightmargin=10pt,innertopmargin=10pt,innerbottommargin=10pt]{donebox}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textbf{Hydra Cluster Audit \& Hardening}}
\fancyhead[R]{\textbf{February 5, 2026}}
\fancyfoot[C]{\thepage}
\setlength{\headheight}{14pt}

\title{\textbf{Hydra Cluster Audit \& Hardening Report}\\[0.5em]\large 10-Phase Discovery, Cleanup, Network Hardening \& Validation}
\author{Infrastructure Team\\SUNY New Paltz Computer Science}
\date{February 5, 2026}

\begin{document}
\maketitle
\tableofcontents
\newpage

%% ============================================================
\section{Executive Summary}
%% ============================================================

This document records the comprehensive 10-phase audit, cleanup, and hardening of the 3-node Hydra RKE2 Kubernetes cluster performed on February 5, 2026. This follows up on the initial audit performed February 4, 2026.

\begin{donebox}
\textbf{Completed Actions:}
\begin{itemize}[nosep]
  \item Full discovery snapshot of all 3 nodes (Phase 0)
  \item Verified \texttt{/etc/hosts} consistency across cluster (Phase 1.3)
  \item Pinned static IPs on Chimera and Cerberus via netplan (Phase 1.1)
  \item Hardened UFW firewall on all 3 nodes --- removed 27017/MongoDB, 8081, Apache/CUPS from workers, restricted Flannel VXLAN to LAN (Phase 1.2)
  \item Verified RKE2 cluster health --- all 3 nodes Ready, all GPUs visible (Phase 2)
  \item Audited NFS/Storage --- RAID-10 healthy, CSI-NFS operational (Phase 3)
  \item Cleaned up orphaned Docker networks (23), dangling images, stray containers (Phase 4)
  \item Comprehensive Traefik routing audit with 8 findings (Phase 5)
  \item Verified backup automation and etcd snapshots (Phase 6)
  \item Docker vs K8s migration inventory completed (Phase 7)
  \item Deleted 5 orphaned student K8s services, stray Cerberus container (Phase 9)
  \item Final validation scan --- all checks passing (Phase 10)
\end{itemize}
\end{donebox}

\begin{dangerbox}
\textbf{Issues Requiring Attention:}
\begin{itemize}[nosep]
  \item Certbot renewal configuration is \textbf{invalid} --- SSL certificates may fail to renew
  \item git-learning IngressRoute is \textbf{broken} --- points to Docker Traefik dashboard instead of app
  \item \texttt{/api/events} has a priority conflict between two IngressRoutes
  \item Chimera has \textasciitilde428GB reclaimable Docker storage (volumes + build cache)
  \item 14 services still running as standalone Docker containers (not in K8s)
\end{itemize}
\end{dangerbox}

%% ============================================================
\section{Cluster Topology}
%% ============================================================

\begin{table}[H]
\centering
\begin{tabular}{llllll}
\toprule
\textbf{Node} & \textbf{IP} & \textbf{Role} & \textbf{OS} & \textbf{Kernel} & \textbf{Hardware} \\
\midrule
Hydra & 192.168.1.160 & Control plane & Ubuntu 22.04.5 & 5.15.0-164 & 256GB RAM, 64 cores \\
Chimera & 192.168.1.150 & GPU worker & Ubuntu 24.04.2 & 6.8.0-63 & 3x RTX 3090 (72GB) \\
Cerberus & 192.168.1.233 & GPU worker & Ubuntu 24.04.3 & 6.14.0-37 & 2x RTX 5090 (64GB) \\
\bottomrule
\end{tabular}
\caption{Cluster node inventory. All running RKE2 v1.28.4+rke2r1.}
\end{table}

\textbf{Network links:}
\begin{itemize}[nosep]
  \item All nodes connected via 192.168.1.0/24 LAN (gateway 192.168.1.1)
  \item Direct ethernet bridge between Chimera (\texttt{enp69s0}) and Cerberus (\texttt{eno1np0}) --- L2 only, no IP assigned yet (reserved for RDMA/RoCE)
  \item Chimera and Cerberus also have WiFi connections (192.168.1.151 and 192.168.1.242 respectively)
  \item WireGuard VPN: Chimera \texttt{wg0} = 10.8.0.2, Cerberus \texttt{wg0} = 10.8.0.3
\end{itemize}

%% ============================================================
\section{Phase 0: Discovery \& Snapshot}
%% ============================================================

A comprehensive audit script was deployed to all 3 nodes capturing:
\begin{itemize}[nosep]
  \item System info (hostname, kernel, uptime, memory, disk)
  \item Docker state (containers, images, volumes, networks)
  \item K8s state (nodes, pods, services, deployments, ingress routes)
  \item Network config (netplan, UFW, /etc/hosts, NFS exports)
  \item RAID status, GPU info (nvidia-smi)
  \item Web server configs (Apache, Traefik)
\end{itemize}

All snapshots archived to \texttt{/tmp/hydra-audit/}, \texttt{/tmp/chimera-audit/}, and \texttt{/tmp/cerberus-audit/}.

%% ============================================================
\section{Phase 1: Network Hardening}
%% ============================================================

\subsection{Phase 1.1: Static IP Assignment}

Chimera and Cerberus were operating on DHCP-assigned IPs that happened to match their expected addresses. Both were converted to static assignments for reliability.

\begin{table}[H]
\centering
\begin{tabular}{lllll}
\toprule
\textbf{Node} & \textbf{Interface} & \textbf{Before} & \textbf{After} & \textbf{Method} \\
\midrule
Hydra & eno8403 & Static 192.168.1.160 & No change & Already static \\
Chimera & enp71s0 & DHCP $\to$ 192.168.1.150 & Static 192.168.1.150 & netplan apply \\
Cerberus & eno2np1 & DHCP $\to$ 192.168.1.233 & Static 192.168.1.233 & netplan apply \\
\bottomrule
\end{tabular}
\caption{Static IP assignments. Backups created as \texttt{*.bak} files.}
\end{table}

\subsection{Phase 1.2: UFW Firewall Hardening}

\subsubsection{Hydra (Control Plane)}

\begin{successbox}
\textbf{Rules removed:}
\begin{itemize}[nosep]
  \item \texttt{27017/tcp} from Anywhere --- MongoDB port publicly exposed (critical security risk)
  \item \texttt{8081/tcp} from Anywhere --- unused port
  \item \texttt{8472/udp} from Anywhere --- Flannel VXLAN replaced with LAN-only rule
\end{itemize}
\textbf{Rules added:}
\begin{itemize}[nosep]
  \item \texttt{8472/udp} from 192.168.1.0/24 --- Flannel VXLAN (LAN only)
\end{itemize}
\textbf{Preserved:} SSH (22), HTTP (80), HTTPS (443), SSHPiper (2222), WireGuard (51820), K8s API (6443), etcd (2379-2380), Kubelet (10250), NFS (2049, 111), Docker bridges (6969)
\end{successbox}

\subsubsection{Chimera (GPU Worker)}

\begin{successbox}
\textbf{Rules removed:}
\begin{itemize}[nosep]
  \item \texttt{Apache Full} (80,443) from Anywhere --- not a web server
  \item \texttt{Apache Secure} (443) from Anywhere --- redundant
  \item \texttt{6969/tcp} from Anywhere --- auth service lives on Hydra
  \item \texttt{7070/tcp} from Anywhere --- kept specific 192.168.1.148 rule only
  \item \texttt{CUPS} (631) v6 --- print service unnecessary on GPU worker
  \item \texttt{8472/udp} from Anywhere --- replaced with LAN-only
\end{itemize}
\textbf{Rules added:}
\begin{itemize}[nosep]
  \item \texttt{8472/udp} from 192.168.1.0/24 --- Flannel VXLAN (LAN only)
  \item \texttt{10250/tcp} from 192.168.1.0/24 --- Kubelet API
\end{itemize}
\textbf{Result:} Zero publicly-exposed application ports remain (only SSH).
\end{successbox}

\subsubsection{Cerberus (GPU Worker)}

\begin{successbox}
\textbf{Rules removed:}
\begin{itemize}[nosep]
  \item \texttt{8472/udp} from Anywhere --- replaced with LAN-only
\end{itemize}
\textbf{Rules added:}
\begin{itemize}[nosep]
  \item \texttt{8472/udp} from 192.168.1.0/24 --- Flannel VXLAN (LAN only)
  \item \texttt{10250/tcp} from 192.168.1.0/24 --- Kubelet API
\end{itemize}
Cerberus already had the cleanest firewall configuration.
\end{successbox}

\subsection{Phase 1.3: /etc/hosts Consistency}

All 3 nodes already had consistent \texttt{/etc/hosts} entries. No changes needed.

%% ============================================================
\section{Phase 2: RKE2 Cluster Health}
%% ============================================================

\begin{donebox}
\textbf{All checks passed:}
\begin{itemize}[nosep]
  \item All 3 nodes: \texttt{Ready} status
  \item GPU resources visible: 3 GPUs on Chimera, 2 GPUs on Cerberus
  \item Control plane components healthy (etcd, scheduler, controller-manager)
  \item No pending CSRs
  \item 75 total pods across 5 namespaces --- all Running/Completed
\end{itemize}
\end{donebox}

K8s namespaces: \texttt{default}, \texttt{gpu-operator}, \texttt{hydra-students} (24 student pods), \texttt{hydra-system}, \texttt{kube-system}, \texttt{local-path-storage}.

%% ============================================================
\section{Phase 3: NFS \& Storage Audit}
%% ============================================================

\begin{table}[H]
\centering
\begin{tabular}{ll}
\toprule
\textbf{Component} & \textbf{Status} \\
\midrule
RAID-10 (md0) & Healthy, 6/6 disks [UUUUUU], 21TB at /data \\
NFS Export & \texttt{/data/containers} $\to$ 192.168.1.0/24 (rw,sync,no\_root\_squash) \\
CSI-NFS & Running on all 3 nodes via DaemonSet \\
StorageClasses & \texttt{hydra-nfs} (nfs.csi.k8s.io) + \texttt{hydra-local} (local-path) \\
Orphaned PVs & None \\
\bottomrule
\end{tabular}
\caption{Storage subsystem status.}
\end{table}

\begin{warningbox}
\textbf{Note:} NFS mounts are handled dynamically via CSI-NFS, not via \texttt{/etc/fstab} on workers. Neither Chimera nor Cerberus have static NFS mounts.
\end{warningbox}

%% ============================================================
\section{Phase 4: Service Cleanup}
%% ============================================================

\subsection{Docker Cleanup}

\begin{table}[H]
\centering
\begin{tabular}{lll}
\toprule
\textbf{Node} & \textbf{Action} & \textbf{Result} \\
\midrule
Hydra & Docker network prune & 23 orphaned networks removed \\
Hydra & Docker image prune & 1 dangling image removed (320MB) \\
Chimera & Docker cleanup (prior session) & Images/volumes pruned \\
Cerberus & Remove stray \texttt{student-gopeen1} & Container removed \\
\bottomrule
\end{tabular}
\caption{Docker cleanup actions across all nodes.}
\end{table}

\subsection{K8s Resource Cleanup}

Five orphaned student services were identified (no matching pods):
\texttt{student-currym6}, \texttt{student-degennac1}, \texttt{student-escurrad1}, \texttt{student-perezd36}, \texttt{student-smallg1}.
These were successfully deleted. 24 active student services remain with healthy pods.

%% ============================================================
\section{Phase 5: Traefik Routing Audit}
%% ============================================================

The cluster uses K8s Traefik (v2.11) as the primary reverse proxy, exposed via NodePort on ports 80:30080, 443:30443, and 6969:30969. Apache is \textbf{not running} --- configs exist but are dormant.

\subsection{IngressRoute Inventory}

\begin{table}[H]
\centering
\begin{tabular}{lll}
\toprule
\textbf{IngressRoute} & \textbf{Host/Path} & \textbf{Backend} \\
\midrule
hydra-main & hydra.newpaltz.edu (catch-all) & hydra-auth:6969 \\
cs-lab-website & /api/ prefix & cs-lab-backend:5001 \\
hackathons & /hackathons/ prefix & hackathons-external:45821 \\
java-executor & /java/ prefix & java-executor-external:55392 \\
git-learning & /git/ prefix & git-learning-external:8080 \\
n8n & n8n.hydra.newpaltz.edu & n8n-external:5678 \\
openwebui & gpt.hydra.newpaltz.edu & openwebui-chimera:3000 \\
hydra-default & HTTP $\to$ HTTPS redirect & Redirect scheme \\
\bottomrule
\end{tabular}
\caption{IngressRoute summary.}
\end{table}

\subsection{Critical Findings}

\begin{dangerbox}
\textbf{1. git-learning route is BROKEN}\\
The \texttt{git-learning-external} ExternalName service points to 192.168.1.160:8080, which is the Docker Traefik dashboard port, not the git-learning app. The actual git-learning container (\texttt{gg-git-learning-app-1}) exposes port 38765 with no host binding.

\textbf{2. /api/events priority conflict}\\
Both \texttt{cs-lab-website} (priority 20) and \texttt{hydra-main} (priority 15) match \texttt{/api/events}. The higher-priority cs-lab route wins, which may not be intended.

\textbf{3. hydra-forward-auth middleware unused}\\
The ForwardAuth middleware is defined but not attached to any IngressRoute.
\end{dangerbox}

\begin{warningbox}
\textbf{4. Dead backend services:} Student proxy (8082), placeframe (6721), and studentmvp (5175) are referenced in legacy Apache configs but have no listeners.

\textbf{5. Docker Traefik overlap:} A Docker Traefik (v3.3) instance runs alongside K8s Traefik, handling only the n8n Docker network routing and its own dashboard on port 8080.
\end{warningbox}

%% ============================================================
\section{Phase 6: Backup Automation}
%% ============================================================

\begin{table}[H]
\centering
\begin{tabular}{lll}
\toprule
\textbf{Backup Type} & \textbf{Schedule} & \textbf{Status} \\
\midrule
Cluster OS (rsync to Seagate) & Daily at 1:00 AM & Active (crontab) \\
Certbot renewal & Weekly (Saturday 2:45 AM) & \textbf{Invalid config!} \\
etcd snapshots & Every 12 hours (automatic) & Working (latest: Feb 5 12:00) \\
\bottomrule
\end{tabular}
\caption{Backup and maintenance automation.}
\end{table}

The backup script (\texttt{/usr/local/bin/backup-cluster.sh}) performs full rsync of all 3 nodes to \texttt{/mnt/sdh4/backups/}, excluding transient directories (proc, sys, tmp, docker, cache).

\begin{dangerbox}
\textbf{Certbot Issue:} The renewal configuration at \texttt{/etc/letsencrypt/renewal/hydra.newpaltz.edu.conf} is reported as \textbf{invalid}. SSL certificates for \texttt{hydra.newpaltz.edu} and \texttt{gpt.hydra.newpaltz.edu} may fail to auto-renew. Requires manual investigation.
\end{dangerbox}

%% ============================================================
\section{Phase 7: Docker-to-K8s Migration Assessment}
%% ============================================================

14 services are still running as standalone Docker containers across the cluster:

\begin{longtable}{p{3.2cm}llll}
\toprule
\textbf{Service} & \textbf{Runtime} & \textbf{Node} & \textbf{K8s Ready?} & \textbf{Priority} \\
\midrule
\endhead
Traefik (Docker) & Docker & Hydra & Duplicate & Skip \\
n8n + Postgres & Docker & Hydra & No & Medium \\
Hackathon Voting & Docker & Hydra & No & Low \\
SSHPiper & Docker & Hydra & No & High \\
Git Learning & Docker & Hydra & No & Low \\
Java Executor & Docker & Hydra & No & Low \\
Ollama & Docker & Chimera & No & High \\
Open WebUI & Docker & Chimera & No & High \\
OpenWebUI Middleman & Docker & Chimera & No & Medium \\
Ray Head & Docker & Chimera & No & High \\
Ray Worker & Docker & Cerberus & No & High \\
\bottomrule
\caption{Docker container migration inventory.}
\end{longtable}

\textbf{Recommended migration order:}
\begin{enumerate}[nosep]
  \item \textbf{Phase 1 (High):} Ray cluster (Head + Worker) via KubeRay operator; Ollama + Open WebUI
  \item \textbf{Phase 2 (Medium):} SSHPiper, n8n stack (requires PVC for Postgres)
  \item \textbf{Phase 3 (Low):} Git Learning, Java Executor, Hackathon Voting
  \item \textbf{Decommission:} Docker Traefik (K8s Traefik already primary)
\end{enumerate}

%% ============================================================
\section{Phase 10: Final Validation}
%% ============================================================

\begin{table}[H]
\centering
\begin{tabular}{lll}
\toprule
\textbf{Check} & \textbf{Result} & \textbf{Status} \\
\midrule
K8s nodes Ready (3/3) & All Ready & \textcolor{green!50!black}{\textbf{PASS}} \\
All pods Running & 0 pods in error state & \textcolor{green!50!black}{\textbf{PASS}} \\
GPU visibility (3+2) & 5 GPUs total & \textcolor{green!50!black}{\textbf{PASS}} \\
Hydra $\to$ Chimera ping & 0.257ms & \textcolor{green!50!black}{\textbf{PASS}} \\
Hydra $\to$ Cerberus ping & 0.601ms & \textcolor{green!50!black}{\textbf{PASS}} \\
Static IPs persisted & .150 and .233 confirmed & \textcolor{green!50!black}{\textbf{PASS}} \\
UFW hardened (all nodes) & No public app ports on workers & \textcolor{green!50!black}{\textbf{PASS}} \\
RAID-10 healthy & 6/6 disks [UUUUUU] & \textcolor{green!50!black}{\textbf{PASS}} \\
etcd snapshots & Every 12h, latest today & \textcolor{green!50!black}{\textbf{PASS}} \\
Docker containers healthy & All UP across 3 nodes & \textcolor{green!50!black}{\textbf{PASS}} \\
Certbot renewal & Config invalid & \textcolor{red}{\textbf{FAIL}} \\
git-learning route & Broken backend & \textcolor{red}{\textbf{FAIL}} \\
\bottomrule
\end{tabular}
\caption{Final validation results: 10 PASS, 2 FAIL.}
\end{table}

%% ============================================================
\section{Recommendations}
%% ============================================================

\begin{enumerate}
  \item \textbf{Fix Certbot:} Investigate and repair \texttt{/etc/letsencrypt/renewal/hydra.newpaltz.edu.conf}. Test with \texttt{certbot renew --dry-run}.
  \item \textbf{Fix git-learning route:} Either bind \texttt{gg-git-learning-app-1} to a host port and update the ExternalName service, or migrate to K8s.
  \item \textbf{Begin Ray/Ollama K8s migration:} The GPU operator and multi-node cluster are ready. KubeRay operator would provide proper GPU scheduling.
  \item \textbf{Resolve /api/events priority conflict:} Adjust IngressRoute priorities to ensure correct routing.
  \item \textbf{Clean Chimera Docker storage:} Reclaim \textasciitilde428GB of unused Docker volumes and build cache.
  \item \textbf{Set up SSH key auth:} Replace password-based SSH between nodes with key-based authentication.
  \item \textbf{Consider DHCP reservation on router:} As a belt-and-suspenders approach alongside static netplan configs.
\end{enumerate}

%% ============================================================
\section{Appendix: UFW Final State}
%% ============================================================

\subsection{Hydra}
\begin{lstlisting}[style=bash]
Status: active (deny incoming, allow outgoing)
22/tcp          ALLOW IN  Anywhere
80/tcp          ALLOW IN  Anywhere
443             ALLOW IN  Anywhere
6969            ALLOW IN  172.17.0.0/16, 172.24.0.0/16
51820/udp       ALLOW IN  Anywhere
6443/tcp        ALLOW IN  192.168.1.0/24  # K8s API
9345/tcp        ALLOW IN  192.168.1.0/24  # RKE2 supervisor
10250/tcp       ALLOW IN  192.168.1.0/24  # Kubelet
2379:2380/tcp   ALLOW IN  192.168.1.0/24  # etcd
2222/tcp        ALLOW IN  Anywhere        # SSHPiper
2049/tcp        ALLOW IN  192.168.1.0/24  # NFS
111/tcp,udp     ALLOW IN  192.168.1.0/24  # portmapper
8472/udp        ALLOW IN  192.168.1.0/24  # Flannel VXLAN
\end{lstlisting}

\subsection{Chimera}
\begin{lstlisting}[style=bash]
Status: active (deny incoming, allow outgoing)
22/tcp          ALLOW IN  Anywhere
7070/tcp        ALLOW IN  192.168.1.148   # OpenWebUI middleman
5201            ALLOW IN  10.10.10.0/24   # iperf
9100            ALLOW IN  192.168.1.0/24  # Metrics
4791/udp        ALLOW IN  192.168.1.0/24  # RoCEv2
Anywhere        ALLOW IN  192.168.1.0/24  # LAN (RDMA)
8472/udp        ALLOW IN  192.168.1.0/24  # Flannel VXLAN
10250/tcp       ALLOW IN  192.168.1.0/24  # Kubelet
\end{lstlisting}

\subsection{Cerberus}
\begin{lstlisting}[style=bash]
Status: active (deny incoming, allow outgoing)
22/tcp          ALLOW IN  Anywhere
5201            ALLOW IN  10.10.10.0/24   # iperf
9100            ALLOW IN  192.168.1.160   # Metrics from Hydra
2376            ALLOW IN  192.168.1.160   # Docker from Hydra
4791/udp        ALLOW IN  192.168.1.0/24  # RoCEv2
Anywhere        ALLOW IN  192.168.1.0/24  # LAN (RDMA)
8472/udp        ALLOW IN  192.168.1.0/24  # Flannel VXLAN
10250/tcp       ALLOW IN  192.168.1.0/24  # Kubelet
\end{lstlisting}

\end{document}
