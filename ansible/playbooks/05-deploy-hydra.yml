# Deploy Hydra K8s manifests
---
- name: Deploy Hydra Stack to Kubernetes
  hosts: control_plane
  become: yes

  vars:
    k8s_manifests_dir: "{{ playbook_dir }}/../../k8s"
    kubeconfig: /etc/rancher/rke2/rke2.yaml

  tasks:
    - name: Create temporary manifests directory
      file:
        path: /tmp/hydra-manifests
        state: directory
        mode: '0755'

    - name: Copy K8s manifests to server
      synchronize:
        src: "{{ k8s_manifests_dir }}/"
        dest: /tmp/hydra-manifests/
        recursive: yes
        delete: yes

    # Apply base manifests
    - name: Apply namespaces
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/base/namespace.yaml
      register: ns_result
      changed_when: "'created' in ns_result.stdout or 'configured' in ns_result.stdout"

    - name: Apply RBAC
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/base/rbac/
      register: rbac_result

    - name: Apply storage classes
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/base/storage/storage-classes.yaml
      register: sc_result
      ignore_errors: yes  # May already exist

    # Install Traefik CRDs if needed
    - name: Check if Traefik CRDs exist
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl get crd ingressroutes.traefik.io
      register: traefik_crds
      ignore_errors: yes
      changed_when: false

    - name: Install Traefik CRDs
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v2.10/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml
      when: traefik_crds.rc != 0

    # Deploy components
    - name: Deploy Traefik
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/traefik/
      register: traefik_result

    - name: Deploy Hydra Auth
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/hydra-auth/
      register: hydra_result

    # Wait for core deployments
    - name: Wait for Traefik deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-system wait --for=condition=Available deployment/traefik --timeout=180s
      register: traefik_ready
      retries: 3
      delay: 20
      until: traefik_ready.rc == 0

    - name: Wait for Hydra Auth deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-system wait --for=condition=Available deployment/hydra-auth --timeout=180s
      register: hydra_ready
      retries: 3
      delay: 20
      until: hydra_ready.rc == 0

    # Deploy infra components to hydra-infra namespace
    - name: Ensure hydra-infra namespace exists
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl get namespace hydra-infra || kubectl create namespace hydra-infra
      register: infra_ns_result
      changed_when: "'created' in infra_ns_result.stdout"

    - name: Apply infra RBAC
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/base/rbac/infra-rbac.yaml
      register: infra_rbac_result

    - name: Deploy CS Lab website
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/cs-lab/
      register: cslab_result

    - name: Deploy hackathons
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/hackathons/
      register: hackathons_result

    - name: Deploy java-executor
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/java-executor/
      register: java_executor_result

    - name: Deploy sshpiper
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/sshpiper/
      register: sshpiper_result

    - name: Deploy git-learning
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/git-learning/
      register: git_learning_result

    - name: Deploy n8n
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/n8n/
      register: n8n_result

    - name: Deploy ollama
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/ollama/
      register: ollama_result

    - name: Deploy openwebui
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/openwebui/
      register: openwebui_result

    - name: Deploy ray
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl apply -f /tmp/hydra-manifests/components/ray/
      register: ray_result

    # Wait for infra deployments
    - name: Wait for CS Lab backend deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-system wait --for=condition=Available deployment/cs-lab-backend --timeout=180s
      register: cslab_ready
      retries: 3
      delay: 20
      until: cslab_ready.rc == 0

    - name: Wait for hackathons deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/hackathons --timeout=180s
      register: hackathons_ready
      retries: 3
      delay: 20
      until: hackathons_ready.rc == 0

    - name: Wait for java-executor deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/java-executor --timeout=180s
      register: java_executor_ready
      retries: 3
      delay: 20
      until: java_executor_ready.rc == 0

    - name: Wait for sshpiper deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/sshpiper --timeout=180s
      register: sshpiper_ready
      retries: 3
      delay: 20
      until: sshpiper_ready.rc == 0

    - name: Wait for git-learning deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/git-learning --timeout=180s
      register: git_learning_ready
      retries: 3
      delay: 20
      until: git_learning_ready.rc == 0

    - name: Wait for n8n deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/n8n --timeout=180s
      register: n8n_ready
      retries: 3
      delay: 20
      until: n8n_ready.rc == 0

    - name: Wait for ollama deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/ollama --timeout=180s
      register: ollama_ready
      retries: 3
      delay: 20
      until: ollama_ready.rc == 0

    - name: Wait for open-webui deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/open-webui --timeout=180s
      register: openwebui_ready
      retries: 3
      delay: 20
      until: openwebui_ready.rc == 0

    - name: Wait for ray-head deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/ray-head --timeout=180s
      register: ray_head_ready
      retries: 3
      delay: 20
      until: ray_head_ready.rc == 0

    - name: Wait for ray-worker deployment
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl -n hydra-infra wait --for=condition=Available deployment/ray-worker --timeout=180s
      register: ray_worker_ready
      retries: 3
      delay: 20
      until: ray_worker_ready.rc == 0

    # Verify deployment
    - name: Get all pods
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl get pods -A -o wide
      register: all_pods

    - name: Display pod status
      debug:
        var: all_pods.stdout_lines

    - name: Get services
      shell: |
        export KUBECONFIG={{ kubeconfig }}
        kubectl get svc -A
      register: all_services

    - name: Display services
      debug:
        var: all_services.stdout_lines

    - name: Deployment complete
      debug:
        msg: |
          =============================================
          Hydra RKE2 Cluster Deployment Complete!
          =============================================

          Control Plane: {{ ansible_host }}
          Kubeconfig: {{ kubeconfig }}

          Access:
            - Hydra Dashboard: https://{{ cluster_domain }}
            - kubectl: export KUBECONFIG={{ kubeconfig }}

          Next steps:
            1. Configure DNS for {{ cluster_domain }}
            2. Setup TLS certificates (cert-manager recommended)
            3. Configure SAML IdP settings
            4. Test student container creation
          =============================================
