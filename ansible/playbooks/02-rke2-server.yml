# Setup RKE2 server (control plane) on Hydra
# SAFE: Preserves existing token if cluster already exists
---
- name: Setup RKE2 Server on Control Plane
  hosts: control_plane
  become: yes

  vars:
    rke2_config_dir: /etc/rancher/rke2
    rke2_data_dir: /data/rke2
    # Token file - use existing if present, generate once if not
    token_file: "{{ playbook_dir }}/../.cluster-token"

  tasks:
    # ============ PRE-FLIGHT CHECKS ============
    - name: Check if RKE2 is already installed and running
      systemd:
        name: rke2-server
      register: rke2_current_status
      ignore_errors: yes

    - name: Display current RKE2 status
      debug:
        msg: "RKE2 server status: {{ rke2_current_status.status.ActiveState | default('not installed') }}"

    - name: Check for existing node token
      stat:
        path: /data/rke2/server/node-token
      register: existing_token_file

    # ============ TOKEN MANAGEMENT (CRITICAL FOR IDEMPOTENCY) ============
    - name: Read existing token if cluster already running
      slurp:
        src: /data/rke2/server/node-token
      register: existing_token
      when: existing_token_file.stat.exists

    - name: Use existing token
      set_fact:
        cluster_token: "{{ existing_token.content | b64decode | trim }}"
      when: existing_token_file.stat.exists

    - name: Check for saved token file on control machine
      local_action:
        module: stat
        path: "{{ token_file }}"
      register: saved_token_file
      become: no
      when: not existing_token_file.stat.exists

    - name: Read saved token from control machine
      local_action:
        module: slurp
        src: "{{ token_file }}"
      register: saved_token
      become: no
      when:
        - not existing_token_file.stat.exists
        - saved_token_file.stat.exists | default(false)

    - name: Use saved token
      set_fact:
        cluster_token: "{{ saved_token.content | b64decode | trim }}"
      when:
        - not existing_token_file.stat.exists
        - saved_token_file.stat.exists | default(false)

    - name: Generate new token ONLY if no existing token found
      set_fact:
        cluster_token: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=64') }}"
      when:
        - not existing_token_file.stat.exists
        - not (saved_token_file.stat.exists | default(false))

    - name: Save token to control machine for future runs
      local_action:
        module: copy
        content: "{{ cluster_token }}"
        dest: "{{ token_file }}"
        mode: '0600'
      become: no

    - name: Display token status (not the token itself)
      debug:
        msg: "Token source: {{ 'existing cluster' if existing_token_file.stat.exists else ('saved file' if saved_token_file.stat.exists | default(false) else 'newly generated') }}"

    # ============ RKE2 CONFIGURATION ============
    - name: Create RKE2 config directory
      file:
        path: "{{ rke2_config_dir }}"
        state: directory
        mode: '0755'

    - name: Check if config already exists
      stat:
        path: "{{ rke2_config_dir }}/config.yaml"
      register: existing_config

    - name: Backup existing config before changes
      copy:
        src: "{{ rke2_config_dir }}/config.yaml"
        dest: "{{ rke2_config_dir }}/config.yaml.bak.{{ ansible_date_time.epoch }}"
        remote_src: yes
      when: existing_config.stat.exists

    - name: Configure RKE2 server
      copy:
        dest: "{{ rke2_config_dir }}/config.yaml"
        content: |
          # RKE2 Server Configuration
          # Generated by Ansible - DO NOT manually edit token!
          token: "{{ cluster_token }}"

          # Networking - MUST match existing if upgrading
          cluster-cidr: "{{ cluster_cidr }}"
          service-cidr: "{{ service_cidr }}"
          cluster-domain: cluster.local

          # TLS SANs for API server
          tls-san:
            - "{{ ansible_host }}"
            - "{{ inventory_hostname }}"
            - "{{ cluster_domain }}"
            - "hydra.local"
            - "127.0.0.1"
            - "localhost"

          # Disable default ingress (we use our own Traefik)
          disable:
            - rke2-ingress-nginx

          # Node labels
          node-label:
            - "hydra.node-role={{ node_role }}"
            - "hydra.gpu-enabled=false"

          # Write kubeconfig with proper permissions
          write-kubeconfig-mode: "0644"

          # Data directory on RAID (/data is mdadm RAID-10, 21TB)
          data-dir: {{ rke2_data_dir }}

          # Kubelet eviction thresholds (OOM prevention)
          kubelet-arg:
            - "eviction-hard=memory.available<2Gi,nodefs.available<10%"
            - "eviction-soft=memory.available<4Gi,nodefs.available<15%"
            - "eviction-soft-grace-period=memory.available=30s,nodefs.available=1m"
            - "eviction-max-pod-grace-period=120"
            - "system-reserved=memory=4Gi,cpu=2"
            - "kube-reserved=memory=2Gi,cpu=1"
        mode: '0600'
      register: config_changed

    # ============ RKE2 INSTALLATION ============
    - name: Check if RKE2 binary exists
      stat:
        path: /usr/local/bin/rke2
      register: rke2_binary

    - name: Download RKE2 installer
      get_url:
        url: https://get.rke2.io
        dest: /tmp/rke2-install.sh
        mode: '0755'
      when: not rke2_binary.stat.exists

    - name: Install RKE2 server
      shell: |
        INSTALL_RKE2_CHANNEL={{ rke2_channel }} \
        INSTALL_RKE2_VERSION={{ rke2_version }} \
        INSTALL_RKE2_TYPE=server \
        /tmp/rke2-install.sh
      args:
        creates: /usr/local/bin/rke2
      when: not rke2_binary.stat.exists

    # ============ SERVICE MANAGEMENT ============
    - name: Enable RKE2 server service
      systemd:
        name: rke2-server
        enabled: yes
        daemon_reload: yes

    - name: Start RKE2 server (if not running)
      systemd:
        name: rke2-server
        state: started
      when: rke2_current_status.status.ActiveState | default('inactive') != 'active'

    - name: Restart RKE2 server (if config changed and already running)
      systemd:
        name: rke2-server
        state: restarted
      when:
        - config_changed.changed
        - rke2_current_status.status.ActiveState | default('inactive') == 'active'

    - name: Wait for RKE2 API to be ready
      wait_for:
        port: 6443
        host: "{{ ansible_host }}"
        delay: 10
        timeout: 300

    - name: Wait for node to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
        /data/rke2/bin/kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=300s
      register: node_ready
      retries: 10
      delay: 30
      until: node_ready.rc == 0

    # ============ POST-INSTALL SETUP ============
    - name: Create kubectl symlink
      file:
        src: /data/rke2/bin/kubectl
        dest: /usr/local/bin/kubectl
        state: link
        force: yes

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0700'

    - name: Setup kubeconfig for root
      copy:
        src: /etc/rancher/rke2/rke2.yaml
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'

    - name: Fetch kubeconfig to control machine
      fetch:
        src: /etc/rancher/rke2/rke2.yaml
        dest: "{{ playbook_dir }}/../kubeconfig-{{ inventory_hostname }}.yaml"
        flat: yes

    - name: Fix kubeconfig server address for external access
      local_action:
        module: replace
        path: "{{ playbook_dir }}/../kubeconfig-{{ inventory_hostname }}.yaml"
        regexp: '127.0.0.1'
        replace: "{{ ansible_host }}"
      become: no

    # Store token as fact for agent playbook
    - name: Store node token as fact
      set_fact:
        rke2_node_token: "{{ cluster_token }}"
        cacheable: yes

    - name: Deployment complete
      debug:
        msg: |
          âœ… RKE2 Server Ready

          API Server: https://{{ ansible_host }}:6443
          Kubeconfig: {{ playbook_dir }}/../kubeconfig-{{ inventory_hostname }}.yaml

          Token preserved: {{ 'yes (existing)' if existing_token_file.stat.exists else 'yes (new/saved)' }}

          Next: Run 03-rke2-agents.yml to join GPU nodes
